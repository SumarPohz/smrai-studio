<%
/* ===================================================================
   _ats-base.ejs  —  Shared ATS-optimised two-column template
   Called by role-specific wrappers that supply a `roleConfig` object.
   =================================================================== */

/* Map skill names → icon paths */
const TF_ICONS = {
  "css":          "/images/skills/css.png",
  "docker":       "/images/skills/docker.png",
  "express":      "/images/skills/express.png",
  "express.js":   "/images/skills/express.png",
  "figma":        "/images/skills/figma.png",
  "firebase":     "/images/skills/firebase.png",
  "framer":       "/images/skills/framer.png",
  "go":           "/images/skills/go.png",
  "golang":       "/images/skills/go.png",
  "graphql":      "/images/skills/graphql.png",
  "html":         "/images/skills/html.png",
  "html5":        "/images/skills/html.png",
  "javascript":   "/images/skills/js.png",
  "js":           "/images/skills/js.png",
  "mongodb":      "/images/skills/mongodb.png",
  "mongo":        "/images/skills/mongodb.png",
  "mui":          "/images/skills/mui.png",
  "material ui":  "/images/skills/mui.png",
  "material-ui":  "/images/skills/mui.png",
  "mysql":        "/images/skills/mysql.png",
  "next":         "/images/skills/next.png",
  "next.js":      "/images/skills/next.png",
  "nextjs":       "/images/skills/next.png",
  "node":         "/images/skills/node.png",
  "node.js":      "/images/skills/node.png",
  "nodejs":       "/images/skills/node.png",
  "postgresql":   "/images/skills/postgresql.png",
  "postgres":     "/images/skills/postgresql.png",
  "prisma":       "/images/skills/prisma.png",
  "react":        "/images/skills/react.png",
  "react native": "/images/skills/reactnative.png",
  "reactnative":  "/images/skills/reactnative.png",
  "react-native": "/images/skills/reactnative.png",
  "react query":  "/images/skills/reactquery.png",
  "reactquery":   "/images/skills/reactquery.png",
  "tanstack":     "/images/skills/reactquery.png",
  "redux":        "/images/skills/redux.png",
  "stripe":       "/images/skills/stripe.png",
  "tailwind":     "/images/skills/tailwind.png",
  "tailwindcss":  "/images/skills/tailwind.png",
  "tauri":        "/images/skills/tauri.png",
  "typescript":   "/images/skills/ts.png",
  "ts":           "/images/skills/ts.png",
};
function tfIcon(skill) {
  return TF_ICONS[skill.toLowerCase().trim()] || null;
}

/* Parse certifications text into list items */
const certLines = (data.certifications || "")
  .split(/\r?\n+/).map(l => l.trim().replace(/^[-•*]\s*/, "")).filter(Boolean);

/* Convert **bold** markdown to <strong> (safe — HTML-escapes first) */
function boldMd(text) {
  return (text || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}

/* Auto-bold the name/title part of a cert/award/training line */
function boldEntry(text) {
  if ((text || '').includes('**')) return boldMd(text);
  const safe = (text || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  const emMatch = safe.match(/^(.*?)\s+—\s+(\d{4}.*)$/);
  if (emMatch) return '<strong>' + emMatch[1] + '</strong> — ' + emMatch[2];
  const hyphenMatch = safe.match(/^(.*?)\s+-\s+(.+)$/);
  if (hyphenMatch) return '<strong>' + hyphenMatch[1] + '</strong> - ' + hyphenMatch[2];
  return safe;
}

/* Role config with defaults */
const rc = (typeof roleConfig !== 'undefined' && roleConfig) ? roleConfig : {};
const _expHeading         = rc.expHeading         || "Experience";
const _achievementHeading = rc.achievementHeading || "Key Achievements";
const _projectHeading     = rc.projectHeading     || "Projects";
const _volunteerHeading   = rc.volunteerHeading   || "Volunteering";
const _skillsHeading      = rc.skillsHeading      || "Skills";
const _certHeading        = rc.certHeading        || "Certifications";
const _trainingHeading    = rc.trainingHeading    || "Training & Courses";
const _awardsHeading      = rc.awardsHeading      || "Awards";
const _eduHeading         = rc.eduHeading         || "Education";
const _langHeading        = rc.langHeading        || "Languages";
const _wrapClass          = rc.wrapClass          || "";
%>

<div class="tf-wrap tf-wrap--ats<%= _wrapClass ? ' ' + _wrapClass : '' %>">

  <!-- ═══════════════ HEADER ═══════════════ -->
  <div class="tf-header">

    <!-- Photo -->
    <% if (data.profileImageUrl) { %>
      <img src="<%= data.profileImageUrl %>" alt="" role="presentation" class="tf-photo" />
    <% } else { %>
      <div class="tf-no-photo">
        <span><%= (data.fullName || "U").charAt(0).toUpperCase() %></span>
      </div>
    <% } %>

    <!-- Name / role / contact -->
    <div class="tf-header-info">
      <h1 class="tf-name"><%= data.fullName || "" %></h1>
      <p class="tf-role"><%= data.roleTitle || "" %></p>

      <div class="tf-contact-row">
        <% if (data.phone) { %>
          <span class="tf-contact-item">
            <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12a19.79 19.79 0 0 1-3-8.59A2 2 0 0 1 3.77 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 8.91a16 16 0 0 0 5.61 5.61l.91-.91a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            <span class="tf-contact-label">Phone:</span> <a href="tel:<%= data.phone %>"><%= data.phone %></a>
          </span>
        <% } %>
        <% if (data.email) { %>
          <span class="tf-contact-item">
            <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,12 2,6"></polyline></svg>
            <span class="tf-contact-label">Email:</span> <a href="mailto:<%= data.email %>"><%= data.email %></a>
          </span>
        <% } %>
        <% if (data.location) { %>
          <span class="tf-contact-item">
            <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            <span class="tf-contact-label">Location:</span> <%= data.location %><% if (data.zipCode) { %> <span class="tf-contact-label">ZIP:</span> <%= data.zipCode %><% } %>
          </span>
        <% } %>
      </div>

      <div class="tf-links-row">
        <% if (data.portfolioUrl) { %>
          <span class="tf-link-item">
            <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
            <a href="<%= data.portfolioUrl %>"><%= data.portfolioUrl.replace(/^https?:\/\//, '') %></a>
          </span>
        <% } %>
        <% if (data.githubUrl) { %>
          <span class="tf-link-item">
            <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            <a href="<%= data.githubUrl %>"><%= data.githubUrl.replace(/^https?:\/\//, '') %></a>
          </span>
        <% } %>
        <% if (data.linkedinUrl) { %>
          <span class="tf-link-item">
            <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            <span class="tf-contact-label">LinkedIn:</span> <a href="<%= data.linkedinUrl %>"><%= data.linkedinUrl.replace(/^https?:\/\/(?:www\.)?linkedin\.com\/in\//, '') %></a>
          </span>
        <% } %>
      </div>
    </div>

    <!-- QR code (portfolio or github) -->
    <% if (typeof qrCodeDataUrl !== 'undefined' && qrCodeDataUrl) { %>
      <div class="tf-qr-block">
        <img src="<%= qrCodeDataUrl %>" alt="" role="presentation" class="tf-qr-img" />
        <span class="tf-qr-label">Scan to visit</span>
      </div>
    <% } %>

  </div><!-- /tf-header -->

  <!-- ═══════════════ SUMMARY BAND ═══════════════ -->
  <% if (data.summary) { %>
  <div class="tf-summary-band">
    <h2 class="tf-summary-label">Summary</h2>
    <p><%= data.summary %></p>
  </div>
  <% } %>

  <!-- ═══════════════ BODY (two-column) ═══════════════ -->
  <div class="tf-body">

    <!-- RIGHT CONTENT — placed first in HTML for ATS parse order -->
    <div class="tf-right">

      <!-- Experience -->
      <% if (experienceItems.length || data.experience) { %>
      <div class="tf-right-section">
        <h2 class="tf-section-title"><%= _expHeading %></h2>

        <% if (experienceItems.length) { %>
          <% experienceItems.forEach(function(exp) { %>
            <div class="tf-exp-item">
              <div class="tf-exp-header">
                <div>
                  <% var _pipe = (exp.company || '').indexOf(' | ');
                     var _compName = _pipe !== -1 ? exp.company.slice(0, _pipe).trim() : (exp.company || '');
                     var _compLoc  = _pipe !== -1 ? exp.company.slice(_pipe + 3).trim() : '';
                  %>
                  <span class="tf-exp-title"><%= exp.title %></span>
                  <% if (_compName) { %><span class="tf-exp-company"> · <%= _compName %></span><% } %>
                  <% if (_compLoc) { %><span class="tf-exp-location"> · <%= _compLoc %></span><% } %>
                </div>
                <% if (exp.dates) { %><span class="tf-exp-dates"><%= exp.dates %></span><% } %>
              </div>
              <% if (exp.description) {
                const expLines = exp.description.split(/\r?\n/).map(function(l){ return l.trim().replace(/^[-•*]\s*/, ''); }).filter(Boolean);
              %>
                <ul class="tf-achievement-list">
                  <% expLines.forEach(function(line) { %><li><%- boldMd(line) %></li><% }); %>
                </ul>
              <% } %>
            </div>
          <% }); %>
        <% } else { %>
          <%
            const rawExpLines = (data.experience || '').split(/\r?\n/).map(function(l){ return l.trim().replace(/^[-•*]\s*/, ''); }).filter(Boolean);
          %>
          <ul class="tf-achievement-list">
            <% rawExpLines.forEach(function(line) { %><li><%- boldMd(line) %></li><% }); %>
          </ul>
        <% } %>
      </div>
      <% } %>

      <!-- Key Achievements -->
      <% if (data.achievements) {
        const achievementLines = data.achievements.split(/\r?\n+/).map(l => l.trim().replace(/^[-•*]\s*/, '')).filter(Boolean);
        if (achievementLines.length) { %>
      <div class="tf-right-section">
        <h2 class="tf-section-title"><%= _achievementHeading %></h2>
        <ul class="tf-achievement-list">
          <% achievementLines.forEach(function(line) { %>
            <li><%- boldMd(line) %></li>
          <% }); %>
        </ul>
      </div>
      <% } } %>

      <!-- Projects -->
      <% if (projectItems.length) { %>
      <div class="tf-right-section">
        <h2 class="tf-section-title"><%= _projectHeading %></h2>
        <% projectItems.forEach(function(proj) { %>
          <div class="tf-project-card">
            <div class="tf-project-header">
              <span class="tf-project-name"><%= proj.name %></span>
              <% if (proj.link) { %>
                <a href="<%= proj.link.startsWith('http') ? proj.link : 'https://' + proj.link %>" class="tf-project-link"><%= proj.link.replace(/^https?:\/\//, '') %> ↗</a>
              <% } %>
            </div>
            <% if (proj.tech) { %>
              <div class="tf-project-tech">
                <% proj.tech.split(',').map(function(t){ return t.trim(); }).filter(Boolean).forEach(function(t) { %>
                  <% const icon = tfIcon(t); %>
                  <span class="tf-project-tech-tag">
                    <% if (icon) { %><img src="<%= icon %>" class="tf-skill-icon-sm" alt="" /><% } %>
                    <%= t %>
                  </span>
                <% }); %>
              </div>
            <% } %>
            <% if (proj.description.length) { %>
              <ul class="tf-achievement-list">
                <% proj.description.forEach(function(line) {
                  const cleaned = line.replace(/^[-•*]\s*/, '').trim();
                  if (cleaned) { %><li><%- boldMd(cleaned) %></li><% }
                }); %>
              </ul>
            <% } %>
          </div>
        <% }); %>
      </div>
      <% } %>

      <!-- Volunteering -->
      <% if (data.volunteering) {
        const volunteerLines = data.volunteering
          .split(/\r?\n+/)
          .map(l => l.trim().replace(/^[-*•]\s*/, '').trim())
          .filter(Boolean);
        if (volunteerLines.length) { %>
      <div class="tf-right-section">
        <h2 class="tf-section-title"><%= _volunteerHeading %></h2>
        <ul class="tf-achievement-list">
          <% volunteerLines.forEach(function(line) { %>
            <li><%- boldMd(line) %></li>
          <% }); %>
        </ul>
      </div>
      <% } } %>

    </div><!-- /tf-right -->

    <!-- LEFT SIDEBAR — placed second in HTML; CSS order:1 keeps it visually left -->
    <div class="tf-left">

      <!-- Skills -->
      <div class="tf-left-section">
        <h2 class="tf-section-title"><%= _skillsHeading %></h2>

        <% if (technologiesCategories.length) { %>
          <% technologiesCategories.forEach(function(cat) { %>
            <div class="tf-tech-category">
              <% if (cat.category) { %>
                <div class="tf-tech-cat-label"><%= cat.category %></div>
              <% } %>
              <div class="tf-tech-skills">
                <% cat.skills.forEach(function(skill) { %>
                  <% const icon = tfIcon(skill); %>
                  <span class="tf-tech-tag">
                    <% if (icon) { %><img src="<%= icon %>" class="tf-skill-icon" alt="" /><% } %>
                    <%= skill %>
                  </span>
                <% }); %>
              </div>
            </div>
          <% }); %>
        <% } else if (skillsLines.length) { %>
          <ul class="tf-skill-list">
            <% skillsLines.forEach(function(skill) { %>
              <% const icon = tfIcon(skill); %>
              <li>
                <% if (icon) { %><img src="<%= icon %>" class="tf-skill-icon" alt="" /><% } %>
                <%= skill %>
              </li>
            <% }); %>
          </ul>
        <% } %>
      </div>

      <div class="tf-divider"></div>

      <!-- Education -->
      <% if (data.education) {
        const eduLines = data.education.split(/\r?\n+/).map(function(l){ return l.trim(); }).filter(Boolean);
      %>
      <div class="tf-left-section">
        <h2 class="tf-section-title"><%= _eduHeading %></h2>
        <ul class="tf-cert-list">
          <% eduLines.forEach(function(line) {
            const yearPrefix = line.match(/^(\d{4})\s*[–—-]+\s*(.+)$/);
            let rendered;
            if (yearPrefix) {
              const yr = yearPrefix[1];
              const content = yearPrefix[2].replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
              rendered = '<strong>' + content + '</strong> — ' + yr;
            } else {
              rendered = boldEntry(line);
            }
          %><li><%- rendered %></li><%
          }); %>
        </ul>
      </div>
      <div class="tf-divider"></div>
      <% } %>

      <!-- Training / Courses -->
      <% if (data.training) {
        const trainingLines = data.training.split(/\r?\n+/).map(l => l.trim().replace(/^[-•*]\s*/, '')).filter(Boolean);
        if (trainingLines.length) { %>
      <div class="tf-left-section">
        <h2 class="tf-section-title"><%= _trainingHeading %></h2>
        <ul class="tf-cert-list">
          <% trainingLines.forEach(function(t) { %>
            <li><%- boldEntry(t) %></li>
          <% }); %>
        </ul>
      </div>
      <div class="tf-divider"></div>
      <% } } %>

      <!-- Certifications -->
      <% if (certLines.length) { %>
      <div class="tf-left-section">
        <h2 class="tf-section-title"><%= _certHeading %></h2>
        <ul class="tf-cert-list">
          <% certLines.forEach(function(cert) { %>
            <li><%- boldEntry(cert) %></li>
          <% }); %>
        </ul>
      </div>
      <div class="tf-divider"></div>
      <% } %>

      <!-- Awards -->
      <% if (data.awards) {
        const awardLines = data.awards.split(/\r?\n+/).map(l => l.trim().replace(/^[-•*]\s*/, '')).filter(Boolean);
        if (awardLines.length) { %>
      <div class="tf-left-section">
        <h2 class="tf-section-title"><%= _awardsHeading %></h2>
        <ul class="tf-cert-list">
          <% awardLines.forEach(function(a) { %>
            <li><%- boldEntry(a) %></li>
          <% }); %>
        </ul>
      </div>
      <div class="tf-divider"></div>
      <% } } %>

      <!-- Languages -->
      <% if (data.languages) { %>
      <div class="tf-left-section">
        <h2 class="tf-section-title"><%= _langHeading %></h2>
        <p class="tf-left-text"><%= data.languages %></p>
      </div>
      <% } %>

    </div><!-- /tf-left -->

  </div><!-- /tf-body -->

</div><!-- /tf-wrap -->
