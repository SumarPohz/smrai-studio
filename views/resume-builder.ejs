<%- include("partials/header") %>

<section class="builder-section">
  <div class="builder-header-row">
    <div>
      <h1>Resume Builder</h1>
      <p class="section-subtitle">
        Using template: <strong><%= template %></strong>
        &nbsp;¬∑&nbsp;
        <a href="/resume-templates">Change template</a>
      </p>
    </div>
    <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
      <button type="button" id="aiInterviewBtn" class="btn-ai-interview">
        üé§ AI Interview Mode
      </button>
      <div class="builder-hint-pill">
        Step <span id="rbStepCounter">1</span> of 4
      </div>
    </div>
  </div>

  <!-- ===== AI INTERVIEW MODAL ===== -->
  <div id="aiInterviewModal" class="ai-modal-overlay" style="display:none;" aria-modal="true" role="dialog">
    <div class="ai-modal">
      <div class="ai-modal-header">
        <div>
          <h2 class="ai-modal-title">üé§ AI Interview Mode</h2>
          <p class="ai-modal-subtitle">Answer a few questions and we'll build your resume automatically.</p>
        </div>
        <button type="button" id="aiModalClose" class="ai-modal-close" aria-label="Close">&times;</button>
      </div>

      <!-- Chat area -->
      <div id="aiChatArea" class="ai-chat-area"></div>

      <!-- Input row -->
      <div id="aiInputRow" class="ai-input-row">
        <div class="ai-input-wrapper">
          <input type="text" id="aiAnswerInput" class="ai-answer-input" placeholder="Type your answer..." autocomplete="off" />
          <button type="button" id="aiMicBtn" class="ai-mic-btn" title="Speak your answer" aria-label="Speak your answer">üé§</button>
        </div>
        <button type="button" id="aiSendBtn" class="btn-primary">Send ‚Üí</button>
      </div>
      <div id="aiMicStatus" class="ai-mic-listening"></div>

      <!-- Generate button (shown after Q&A for non-photo templates) -->
      <div id="aiGenerateRow" class="ai-generate-row" style="display:none;">
        <button type="button" id="aiGenerateBtn" class="btn-primary ai-generate-btn">
          ‚ú® Generate My Resume
        </button>
      </div>

      <!-- Photo step (shown after Q&A for photo-supporting templates) -->
      <div id="aiPhotoStep" class="ai-photo-step" style="display:none;">
        <input type="file" id="aiPhotoInput" accept="image/*" style="display:none;" />

        <!-- Initial: choose or skip -->
        <div id="aiPhotoInitial" class="ai-photo-initial">
          <button type="button" id="aiPhotoChooseBtn" class="btn-primary ai-photo-choose-btn">
            üì∑ Upload Photo
          </button>
          <button type="button" id="aiPhotoSkipBtn" class="ai-photo-skip-link">
            Skip ‚Äî no photo
          </button>
        </div>

        <!-- Cropper panel (shown after file selected) -->
        <div id="aiCropPanel" class="ai-crop-panel" style="display:none;">
          <div class="ai-crop-frame">
            <img id="aiCropImg" src="" alt="Crop preview" />
          </div>
          <div class="ai-crop-actions">
            <button type="button" id="aiCropConfirmBtn" class="btn-primary">‚úì Use This Photo</button>
            <button type="button" id="aiCropRetryBtn" class="ai-photo-skip-link">‚Ü© Choose Different</button>
          </div>
        </div>

        <!-- After crop confirmed: thumbnail + generate -->
        <div id="aiPhotoDoneArea" style="display:none;">
          <div class="ai-photo-done-row">
            <img id="aiPhotoThumb" src="" class="ai-photo-thumb" alt="Profile photo" />
            <span class="ai-photo-done-label">Photo ready ‚úì</span>
            <button type="button" id="aiPhotoRedo" class="ai-photo-skip-link">Change</button>
          </div>
          <button type="button" id="aiPhotoGenBtn" class="btn-primary ai-generate-btn">
            ‚ú® Generate My Resume
          </button>
        </div>
      </div>

      <!-- Status -->
      <div id="aiModalStatus" class="ai-modal-status"></div>
    </div>
  </div>

  <div class="builder-main">
    <!-- LEFT: FORM -->
    <div class="builder-left">
      <form
          id="resumeBuilderForm"
          action="/resume-builder/preview"
          method="POST"
          novalidate
        >
        <input type="hidden" name="template" value="<%= template %>">
          <input
            type="hidden"
            name="resumeId"
            id="resumeId"
            value="<%= typeof resumeId !== 'undefined' && resumeId ? resumeId : '' %>"
          >
          <input type="hidden" name="experienceLevel" id="experienceLevelInput" value="experienced">

        <!-- STEP 1: YOUR DETAILS -->
        <div class="rb-step active" data-step="1">
          <h2 class="rb-step-title">Your Details</h2>
          <p class="rb-step-subtitle">
            Start with your basic information. We‚Äôll reuse these details across all templates.
          </p>

          <div class="rb-grid-2">
            <div class="rb-field">
              <label for="fullName">Full Name<span class="req">*</span></label>
              <input
                type="text"
                id="fullName"
                name="fullName"
                required
                value="<%= (draft && draft.fullName) || (profile && profile.full_name) || '' %>"
              />
            </div>

            <div class="rb-field">
              <label for="roleTitle">Job Title<span class="req">*</span></label>
              <input
                type="text"
                id="roleTitle"
                name="roleTitle"
                placeholder="e.g. Account Support Coordinator"
                value="<%= (draft && draft.roleTitle) || (profile && profile.role_title) || '' %>"
              />
            </div>

            <div class="rb-field">
              <label for="email">Email Address<span class="req">*</span></label>
              <input
                type="email"
                id="email"
                name="email"
                required
                value="<%= (draft && draft.email) || (profile && profile.email) || (user && user.email) || '' %>"
              />
            </div>

            <div class="rb-field">
              <label for="phone">Mobile No.<span class="req">*</span></label>
              <input
                type="text"
                id="phone"
                name="phone"
                required
                value="<%= (draft && draft.phone) || (profile && profile.phone) || '' %>"
              />
            </div>


            <div class="rb-field">
              <label for="location">Location<span class="req">*</span></label>
              <input
                type="text"
                id="location"
                name="location"
                placeholder="Bangalore, Karnataka"
                value="<%= (draft && draft.location) || (profile && profile.location) || '' %>"
              />
            </div>

<% const _existingPhoto = (draft && draft.profileImageUrl) || (profile && profile.profile_image_url) || ''; %>
<% if (isPhotoTpl) { %>
            <!-- Photo upload widget (photo-supporting templates only) -->
            <div class="rb-field rb-photo-field">
              <label>Profile Photo <span class="rb-photo-badge">Recommended</span></label>
              <input type="file" id="photoFileInput" accept="image/*" style="display:none;" />
              <input type="hidden" name="profileImageUrl" id="profileImageUrl"
                     value="<%= _existingPhoto %>" />
              <div class="photo-preview-wrap">
                <img id="photoPreviewImg"
                     src="<%= _existingPhoto %>"
                     class="photo-preview-img<%= _existingPhoto ? '' : ' ph-hidden' %>"
                     alt="Profile photo" />
                <div id="photoPlaceholder"
                     class="photo-preview-placeholder<%= _existingPhoto ? ' ph-hidden' : '' %>">
                  <span>No photo</span>
                </div>
              </div>
              <div class="photo-upload-btns">
                <button type="button" id="photoUploadTrigger" class="btn-photo-action">
                  üì∑ Upload Photo
                </button>
                <button type="button" id="photoRemoveBtn"
                        class="btn-photo-action btn-photo-remove<%= _existingPhoto ? '' : ' ph-hidden' %>">
                  Remove
                </button>
              </div>
              <p class="rb-field-hint">Square photo ¬∑ JPG or PNG ¬∑ min 200√ó200px</p>
            </div>
<% } %>
          </div>
        </div>

        <!-- STEP 2: SUMMARY -->
        <div class="rb-step" data-step="2">
          <h2 class="rb-step-title">Professional Summary</h2>
          <p class="rb-step-subtitle">
            Write 3‚Äì5 lines about your professional background, strengths, and the value you bring.
            This section appears at the top of your resume.
          </p> 

          <div class="rb-field rb-field-full ai-field-wrap">
            <div class="ai-field-label">
              <label for="summary">Professional Summary</label>
              <div class="ai-btn-group">
                <span class="fmic-status" aria-live="polite"></span>
                <button type="button" class="ai-mic-field-btn" data-mic-target="summary" title="Voice input" aria-label="Start voice input for Professional Summary">üé§</button>
                <button type="button" class="ai-btn" data-field="summary">‚ú® AI Suggest</button>
                <button type="button" class="ai-undo-btn" data-field="summary" disabled>‚Ü© Undo</button>
              </div>
            </div>
            <textarea
              id="summary"
              name="summary"
              rows="7"
              placeholder="Example: A highly motivated and results-oriented professional..."
            ><%= (draft && draft.summary) || (profile && profile.summary) || '' %></textarea>
          </div>
        </div>

        <!-- STEP 3: EXPERIENCE -->
        <div class="rb-step" data-step="3">
          <h2 class="rb-step-title">Experience</h2>

          <p class="rb-step-subtitle">
            Describe your roles in your own words ‚Äî or use üé§ to speak them.
            Click ‚ú® AI Suggest and we‚Äôll detect each position and structure them automatically.
          </p>

          <div class="rb-field rb-field-full ai-field-wrap">
            <div class="ai-field-label">
              <label for="experience">Experience</label>
              <div class="ai-btn-group">
                <span class="fmic-status" aria-live="polite"></span>
                <button type="button" class="ai-mic-field-btn" data-mic-target="experience" title="Voice input" aria-label="Start voice input for Experience">üé§</button>
                <button type="button" class="ai-btn" data-field="experience">‚ú® AI Suggest</button>
                <button type="button" class="ai-undo-btn" data-field="experience" disabled>‚Ü© Undo</button>
              </div>
            </div>
            <textarea
              id="experience"
              name="experience"
              rows="10"
              placeholder="e.g. I worked as a Security Supervisor at ACPS from 2020 to present. I managed a team of 10 officers..."
            ><%= (draft && draft.experience) || (profile && profile.experience) || '' %></textarea>
          </div>
        </div>

        <!-- STEP 4: EDUCATION, LANGUAGES, SKILLS -->
        <div class="rb-step" data-step="4">
          <h2 class="rb-step-title">Education, Languages &amp; Skills</h2>
          <p class="rb-step-subtitle">
            Add your education details, languages, and key skills. For skills you can again
            use one line per skill ‚Äì we‚Äôll show them as bullet points.
          </p>

          <div class="rb-grid-2">
            <div class="rb-field rb-field-full ai-field-wrap">
              <div class="ai-field-label">
                <label for="education">Education</label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-mic-field-btn" data-mic-target="education" title="Voice input" aria-label="Start voice input for Education">üé§</button>
                  <button type="button" class="ai-btn" data-field="education">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="education" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <textarea
                id="education"
                name="education"
                rows="4"
              ><%= (draft && draft.education) || '' %></textarea>
            </div>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="languages">Languages</label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-mic-field-btn" data-mic-target="languages" title="Voice input" aria-label="Start voice input for Languages">üé§</button>
                  <button type="button" class="ai-btn" data-field="languages">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="languages" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <textarea
                id="languages"
                name="languages"
                rows="4"
              ><%= (draft && draft.languages) || '' %></textarea>
            </div>

            <% if (template === 'bold-sidebar' || template === 'creative-gradient') { %>
            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="references">References <span style="font-weight:400;color:#6b7280;font-size:0.85em;">(optional)</span></label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-mic-field-btn" data-mic-target="references" title="Voice input" aria-label="Start voice input for References">üé§</button>
                  <button type="button" class="ai-btn" data-field="references">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="references" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <p class="rb-field-hint" style="margin:0.2rem 0 0.4rem;font-size:0.82rem;color:#6b7280;">
                Up to 3 referees. Separate each with <code>---</code> on its own line.<br>
                Format per referee: Name ‚Üí Institution ‚Üí Phone ‚Üí Website (one per line).
              </p>
              <textarea
                id="references"
                name="references"
                rows="7"
                placeholder="Rufus Stewart&#10;Borcelle University&#10;+123-456-7890&#10;www.example.com&#10;---&#10;Lorna Alvarado&#10;Borcelle University"
              ><%= (draft && draft.references) || '' %></textarea>
            </div>
            <% } %>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="skills">Skills</label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-mic-field-btn" data-mic-target="skills" title="Voice input" aria-label="Start voice input for Skills">üé§</button>
                  <button type="button" class="ai-btn" data-field="skills">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="skills" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <textarea
                id="skills"
                name="skills"
                rows="4"
              ><%= (draft && draft.skills) || '' %></textarea>
            </div>

            <% if (template === 'tech-focused' || template === 'ats-friendly') { %>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="technologies">Technologies / Stack</label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-btn" data-field="technologies">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="technologies" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <p class="rb-field-hint">One category per line ‚Äî e.g. <em>Frontend: React, TypeScript, Tailwind</em></p>
              <textarea
                id="technologies"
                name="technologies"
                rows="5"
                placeholder="Frontend: React, TypeScript, Tailwind CSS&#10;Backend: Node.js, Python, Express.js&#10;Database: PostgreSQL, MongoDB, Redis&#10;DevOps: Docker, AWS, GitHub Actions&#10;Tools: Git, Postman, Figma"
              ><%= (draft && draft.technologies) || '' %></textarea>
            </div>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="projects">Projects</label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-btn" data-field="projects">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="projects" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <p class="rb-field-hint">Format: <em>Project Name | Tech: React, Node | https://link.com</em> then description on next lines. Blank line to separate projects.</p>
              <textarea
                id="projects"
                name="projects"
                rows="8"
                placeholder="Portfolio Website | Tech: React, Tailwind | github.com/user/portfolio&#10;Built a responsive portfolio with dark mode and animations.&#10;‚Ä¢ Deployed on Vercel with CI/CD pipeline&#10;&#10;API Service | Tech: Python, FastAPI | api.myproject.com&#10;REST API for ML sentiment analysis."
              ><%= (draft && draft.projects) || '' %></textarea>
            </div>

            <div class="rb-field">
              <label for="portfolioUrl">Portfolio or LinkedIn URL <span class="rb-badge-qr">‚Üí QR Code</span></label>
              <p class="rb-field-hint">This URL will be converted to a QR code on your resume.</p>
              <input
                type="url"
                id="portfolioUrl"
                name="portfolioUrl"
                placeholder="https://yourportfolio.com  or  https://linkedin.com/in/yourname"
                value="<%= (draft && draft.portfolioUrl) || '' %>"
              />
            </div>

            <div class="rb-field">
              <label for="githubUrl">GitHub Profile URL</label>
              <input
                type="url"
                id="githubUrl"
                name="githubUrl"
                placeholder="https://github.com/yourusername"
                value="<%= (draft && draft.githubUrl) || '' %>"
              />
            </div>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="certifications">Certifications &amp; Achievements <span style="font-weight:400;color:#6b7280;font-size:0.85em;">(optional)</span></label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-btn" data-field="certifications">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="certifications" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <textarea
                id="certifications"
                name="certifications"
                rows="4"
                placeholder="AWS Certified Solutions Architect ‚Äî 2024&#10;Google Professional Cloud Developer ‚Äî 2023&#10;Meta React Developer Certificate ‚Äî 2022"
              ><%= (draft && draft.certifications) || '' %></textarea>
            </div>

            <% if (template === 'ats-friendly') { %>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="achievements">Key Achievements <span style="font-weight:400;color:#6b7280;font-size:0.85em;">(optional)</span></label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-btn" data-field="achievements">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="achievements" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <p class="rb-field-hint">One achievement per line. ATS scanners rank resumes higher when key wins are listed.</p>
              <textarea
                id="achievements"
                name="achievements"
                rows="4"
                placeholder="Led migration to microservices, reducing load time by 40%&#10;Open-source library with 2k+ GitHub stars&#10;Promoted to Senior Engineer within 18 months"
              ><%= (draft && draft.achievements) || '' %></textarea>
            </div>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="awards">Awards <span style="font-weight:400;color:#6b7280;font-size:0.85em;">(optional)</span></label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-btn" data-field="awards">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="awards" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <p class="rb-field-hint">One award per line ‚Äî e.g. <em>Dean's List ‚Äî Cornell 2022</em></p>
              <textarea
                id="awards"
                name="awards"
                rows="3"
                placeholder="Dean's List ‚Äî Cornell School of Engineering&#10;Hackathon Winner ‚Äî Google DevFest 2023&#10;Best Final Year Project Award"
              ><%= (draft && draft.awards) || '' %></textarea>
            </div>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="training">Training &amp; Courses <span style="font-weight:400;color:#6b7280;font-size:0.85em;">(optional)</span></label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-btn" data-field="training">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="training" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <p class="rb-field-hint">One course per line ‚Äî e.g. <em>Machine Learning ‚Äî Stanford Online, 2023</em></p>
              <textarea
                id="training"
                name="training"
                rows="3"
                placeholder="Full-Stack Web Development ‚Äî freeCodeCamp, 2023&#10;Machine Learning Specialization ‚Äî Coursera, 2022&#10;Introduction to Cloud Computing ‚Äî AWS Training"
              ><%= (draft && draft.training) || '' %></textarea>
            </div>

            <div class="rb-field ai-field-wrap">
              <div class="ai-field-label">
                <label for="volunteering">Volunteering <span style="font-weight:400;color:#6b7280;font-size:0.85em;">(optional)</span></label>
                <div class="ai-btn-group">
                  <span class="fmic-status" aria-live="polite"></span>
                  <button type="button" class="ai-btn" data-field="volunteering">‚ú® AI Suggest</button>
                  <button type="button" class="ai-undo-btn" data-field="volunteering" disabled>‚Ü© Undo</button>
                </div>
              </div>
              <textarea
                id="volunteering"
                name="volunteering"
                rows="3"
                placeholder="Tech Mentor ‚Äî Google Developer Student Club (2022‚ÄìPresent)&#10;Open Source Contributor ‚Äî Mozilla Firefox, reported 3 critical bugs&#10;Code instructor ‚Äî weekend coding bootcamp for underprivileged youth"
              ><%= (draft && draft.volunteering) || '' %></textarea>
            </div>

            <% } %>

            <% } %>

          </div>
        </div>
        <!-- NAVIGATION -->
        <div class="rb-nav">
          <button type="button" class="btn-ghost" id="rbBackBtn">Back</button>

          <div>
            <!-- NEW: Save Draft button (AJAX, does NOT submit the form) -->
            <button type="button" class="btn-ghost" id="rbSaveBtn">
              Save Draft
            </button>

            <button type="button" class="btn-primary" id="rbNextBtn">
              Next
            </button>
            <button type="submit" class="btn-primary" id="rbSubmitBtn" style="display:none;">
              Preview Resume
            </button>
          </div>
        </div>


        <!-- STEP DOTS -->
        <div class="rb-step-indicator">
          <span class="rb-step-dot active"></span>
          <span class="rb-step-dot"></span>
          <span class="rb-step-dot"></span>
          <span class="rb-step-dot"></span>
        </div>
      </form>
    </div>

    <!-- RIGHT: MINI LIVE PREVIEW -->
    <aside class="builder-right">
      <div class="modern-mini-preview">

        <% if (template === 'bold-sidebar') { %>
        <!-- Bold-sidebar: header + divider + two-column body -->
        <div class="modern-mini-page bs-mode">

          <div class="bsmini-header">
            <div class="bsmini-photo"></div>
            <div class="bsmini-header-info">
              <div id="pvName" class="bsmini-name">Your Name</div>
              <div id="pvRole" class="bsmini-role">Your Job Title</div>
              <div class="bsmini-contact">
                <span>üìû <span id="pvPhone">+91 0000000000</span></span>
                <span>‚úâÔ∏è <span id="pvEmail">email@example.com</span></span>
                <span>üìç <span id="pvLocation">City, Country</span></span>
              </div>
            </div>
          </div>

          <div class="bsmini-divider"></div>

          <div class="bsmini-body">
            <div class="bsmini-left">
              <div class="bsmini-section">
                <h3>ABOUT ME</h3>
                <p id="pvSummary">Your concise professional summary will appear here.</p>
              </div>
              <div class="bsmini-section">
                <h3>EDUCATION</h3>
                <p id="pvEducation">Your education entries will appear here.</p>
              </div>
              <div class="bsmini-section">
                <h3>SKILLS</h3>
                <div id="pvSkills" class="modern-mini-skills bsmini-skills">
                  <span>Skills will appear here.</span>
                </div>
              </div>
              <div class="bsmini-section">
                <h3>LANGUAGES</h3>
                <p id="pvLanguages">Languages will appear here.</p>
              </div>
            </div>
            <div class="bsmini-right">
              <div class="bsmini-section">
                <h3>WORK EXPERIENCE</h3>
                <p id="pvExperience">Your experience lines will appear here as you type.</p>
              </div>
            </div>
          </div>

          <!-- Footer strip ‚Äî mirrors the gray Languages+Reference bar in the full template -->
          <div class="bsmini-footer">
            <span>LANGUAGES</span><span>REFERENCE</span>
          </div>

        </div>
        <% } else if (template === 'creative-gradient') { %>
        <!-- Creative-Gradient: blue header + dark sidebar + white content -->
        <div class="modern-mini-page cg-mode">

          <div class="cgmini-header">
            <div class="cgmini-photo"></div>
            <div class="cgmini-header-info">
              <div id="pvName" class="cgmini-name">Your Name</div>
              <div id="pvRole" class="cgmini-role">Your Job Title</div>
            </div>
          </div>

          <div class="cgmini-body">
            <div class="cgmini-left">
              <div class="cgmini-section">
                <h3>CONTACT</h3>
                <p>üìû <span id="pvPhone">+91 0000000000</span></p>
                <p>‚úâÔ∏è <span id="pvEmail">email@example.com</span></p>
                <p>üìç <span id="pvLocation">City, Country</span></p>
              </div>
              <div class="cgmini-section">
                <h3>EDUCATION</h3>
                <p id="pvEducation">Education entries will appear here.</p>
              </div>
              <div class="cgmini-section">
                <h3>SKILLS</h3>
                <div id="pvSkills" class="modern-mini-skills cgmini-skills">
                  <span>Skills will appear here.</span>
                </div>
              </div>
            </div>

            <div class="cgmini-right">
              <div class="cgmini-section">
                <h3>SUMMARY</h3>
                <p id="pvSummary">Your professional summary will appear here.</p>
              </div>
              <div class="cgmini-section">
                <h3>EXPERIENCE</h3>
                <p id="pvExperience">Your experience will appear here as you type.</p>
              </div>
            </div>
          </div>

        </div>
        <% } else if (template === 'tech-focused' || template === 'ats-friendly') { %>
        <!-- Tech-Focused / ATS-Friendly: dark navy header + summary band + two-column body -->
        <div class="modern-mini-page tf-mode">

          <div class="tfmini-header">
            <div class="tfmini-photo"></div>
            <div class="tfmini-header-info">
              <div id="pvName" class="tfmini-name">Your Name</div>
              <div id="pvRole" class="tfmini-role">Your Job Title</div>
              <div class="tfmini-contact">
                <span id="pvPhone">+91 0000000000</span>
                <span id="pvEmail">email@example.com</span>
                <span id="pvLocation">City, Country</span>
              </div>
              <div class="tfmini-links">
                <span id="pvPortfolioUrl">portfolio.com</span>
              </div>
            </div>
            <div class="tfmini-qr-block">
              <div class="tfmini-qr-sq"></div>
              <div class="tfmini-qr-label">QR</div>
            </div>
          </div>

          <div class="tfmini-summary-band">
            <div class="tfmini-band-label">PROFESSIONAL SUMMARY</div>
            <p id="pvSummary">Your professional summary will appear here.</p>
          </div>

          <div class="tfmini-body">
            <div class="tfmini-left">
              <div class="tfmini-section">
                <h3>TECHNICAL SKILLS</h3>
                <div id="pvTechnologies" class="tfmini-tech-content">
                  <span class="tfmini-placeholder">Technologies will appear here.</span>
                </div>
              </div>
              <div class="tfmini-section">
                <h3>EDUCATION</h3>
                <p id="pvEducation">Education entries will appear here.</p>
              </div>
              <div class="tfmini-section">
                <h3>CERTIFICATIONS</h3>
                <p id="pvCertifications">Certifications will appear here.</p>
              </div>
              <div class="tfmini-section">
                <h3>LANGUAGES</h3>
                <p id="pvLanguages">Languages will appear here.</p>
              </div>
            </div>
            <div class="tfmini-right">
              <div class="tfmini-section">
                <h3>WORK EXPERIENCE</h3>
                <p id="pvExperience">Your experience will appear here as you type.</p>
              </div>
              <div class="tfmini-section">
                <h3>PROJECTS</h3>
                <p id="pvProjects">Projects will appear here.</p>
              </div>
            </div>
          </div>

        </div>
        <% } else { %>
        <!-- Modern-1 / generic: navy sidebar + right content -->
        <div class="modern-mini-page">

          <div class="m1mini-left">
            <div class="m1mini-avatar"></div>
            <div id="pvName" class="m1mini-name">Your Name</div>
            <div id="pvRole" class="m1mini-role">Your Job Title</div>
            <div class="m1mini-section">
              <h3>CONTACT</h3>
              <p>üìû <span id="pvPhone">+91 0000000000</span></p>
              <p>‚úâÔ∏è <span id="pvEmail">email@example.com</span></p>
              <p>üìç <span id="pvLocation">City, Country</span></p>
            </div>
            <div class="m1mini-section">
              <h3>EDUCATION</h3>
              <p id="pvEducation">Your education entries will appear here.</p>
            </div>
            <div class="m1mini-section">
              <h3>LANGUAGES</h3>
              <p id="pvLanguages">Languages will appear here.</p>
            </div>
          </div>

          <div class="m1mini-right">
            <div class="m1mini-section">
              <h3>SUMMARY</h3>
              <p id="pvSummary">Your concise professional summary will appear here.</p>
            </div>
            <div class="m1mini-section">
              <h3>EXPERIENCE</h3>
              <p id="pvExperience">Your experience lines will appear here as you type.</p>
            </div>
            <div class="m1mini-section">
              <h3>SKILLS</h3>
              <div id="pvSkills" class="m1mini-skills">
                <span>Skills will appear here.</span>
              </div>
            </div>
          </div>

        </div>
        <% } %>

      </div>
    </aside>
  </div>
</section>

<style>
  .builder-section {
    max-width: 1160px;
    margin: 1.5rem auto 2.5rem;
    padding: 0 1rem 1rem;
  }

  .builder-header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: 1rem;
  }

  .builder-section h1 {
    margin-bottom: 0.3rem;
  }

  .section-subtitle {
    font-size: 0.9rem;
    color: #6b7280;
  }

  .builder-hint-pill {
    align-self: flex-start;
    font-size: 0.85rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: #eff6ff;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
    white-space: nowrap;
  }

  .builder-hint-pill span {
    font-weight: 600;
  }

  .builder-main {
    margin-top: 1.2rem;
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
  }

  .builder-left {
    flex: 1.2;
    min-width: 0;
  }

  .builder-right {
    flex: 1;
    min-width: 280px;
    position: sticky;
    top: 5.5rem;
  }

  .rb-step {
    display: none;
    background: #ffffff;
    padding: 1.8rem 2.2rem;
    border-radius: 18px;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
    margin: 0 auto 0;
  }

  .rb-step + .rb-step {
    margin-top: 1.8rem;
  }

  .rb-step.active {
    display: block;
    animation: rbFadeIn 0.18s ease-out;
  }

  @keyframes rbFadeIn {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .rb-step-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.5rem;
    text-align: left;
  }

  .rb-step-subtitle {
    font-size: 0.95rem;
    color: #4b5563;
    margin-bottom: 1.1rem;
    line-height: 1.6;
    text-align: left;
  }

  .rb-grid-2 {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1rem 1.25rem;
  }

  .rb-field {
    display: flex;
    flex-direction: column;
    text-align: left;
  }

  .rb-field-full {
    grid-column: 1 / -1;
  }

  .rb-field-hint {
    font-size: 0.78rem;
    color: #6b7280;
    margin: 0 0 0.35rem;
  }

  .rb-badge-qr {
    display: inline-block;
    font-size: 0.7rem;
    background: #eff6ff;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
    border-radius: 4px;
    padding: 0.05rem 0.35rem;
    margin-left: 0.4rem;
    font-weight: 500;
  }

  .rb-field label {
    font-size: 0.85rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.25rem;
  }

  .rb-field input,
  .rb-field textarea {
    padding: 0.55rem 0.7rem;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 0.9rem;
    background: #f9fafb;
    transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
  }

  .rb-field input:focus,
  .rb-field textarea:focus {
    outline: none;
    border-color: #2563eb;
    background: #ffffff;
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
  }

  .rb-field textarea {
    min-height: 130px;
    resize: vertical;
    overflow-wrap: anywhere;
  }

  .ai-field-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
}

.ai-btn-group {
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.ai-btn,
.ai-undo-btn {
  border: none;
  font-size: 0.8rem;
  padding: 0.25rem 0.55rem;
  border-radius: 999px;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.05s ease;
  white-space: nowrap;
}

.ai-btn {
  background: #facc15;
  color: #111827;
  font-weight: 600;
}

.ai-btn:hover {
  background: #eab308;
}

.ai-undo-btn {
  background: #e5e7eb;
  color: #111827;
}

.ai-undo-btn:hover {
  background: #d1d5db;
}

.ai-btn:disabled,
.ai-undo-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* ‚îÄ‚îÄ Field-level mic button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.ai-mic-field-btn {
  border: 1px solid #e5e7eb;
  background: #f9fafb;
  color: #6b7280;
  font-size: 0.78rem;
  padding: 0.22rem 0.42rem;
  border-radius: 999px;
  cursor: pointer;
  line-height: 1;
  transition: background 0.15s, color 0.15s, border-color 0.15s, box-shadow 0.15s;
  white-space: nowrap;
}
.ai-mic-field-btn:hover:not(:disabled) {
  background: #f3f4f6;
  color: #374151;
}
.ai-mic-field-btn.fmic-recording {
  background: #fef2f2;
  color: #dc2626;
  border-color: #fca5a5;
  animation: fmicPulse 1.2s ease-in-out infinite;
}
.ai-mic-field-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
@keyframes fmicPulse {
  0%, 100% { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); }
  50%       { box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.35); }
}
.fmic-status {
  font-size: 0.72rem;
  color: #dc2626;
  font-weight: 500;
  white-space: nowrap;
  display: none;
}
.fmic-status.visible { display: inline; }

  .rb-tip {
    margin: 0.4rem 0 0.9rem;
    padding: 0.75rem 0.85rem;
    border-radius: 10px;
    background: #eff6ff;
    border: 1px dashed #bfdbfe;
    font-size: 0.85rem;
    color: #1f2937;
  }

  .rb-tip strong {
    color: #1d4ed8;
  }

  .req {
    color: #ef4444;
    margin-left: 2px;
  }

  .rb-nav {
    max-width: 850px;
    margin: 1.3rem auto 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .rb-step-indicator {
    margin-top: 0.9rem;
    display: flex;
    justify-content: center;
    gap: 0.4rem;
  }

  .rb-step-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #e5e7eb;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .rb-step-dot.active {
    background: #2563eb;
    transform: scale(1.3);
  }

  .rb-step-dot.done {
    background: #22c55e;
  }

  .btn-ghost-disabled,
  .btn-ghost[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* MINI PREVIEW - exact modern-1 layout (small, auto-scaling) */
  /* ===== MINI PREVIEW OUTER (keep class names ‚Äî scaling JS depends on them) ===== */
  .modern-mini-preview {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    position: relative;
    overflow: visible;
  }

  .modern-mini-page {
    position: relative;
    width: 420px;
    max-width: none;
    aspect-ratio: 210 / 297;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
    overflow: hidden;
    display: flex;
    flex-direction: row;          /* default: sidebar + right (modern-1) */
    font-family: "Segoe UI", Arial, sans-serif;
    transform-origin: top center;
    border: 1px solid #e5e7eb;
  }

  /* Bold-sidebar: header stacked above two-column body */
  .modern-mini-page.bs-mode {
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ Creative-Gradient mini layout ‚îÄ‚îÄ */
  .modern-mini-page.cg-mode {
    flex-direction: column;
    background: linear-gradient(to right, #111111 32%, #ffffff 32%);
    overflow: visible;
  }
  .cgmini-header {
    height: 90px;
    margin-top: 40px;
    background: linear-gradient(90deg, #0f2d75 0%, #1f4fb5 100%);
    display: flex;
    align-items: center;
    padding-left: 140px;
    padding-right: 0.6rem;
    position: relative;
    flex-shrink: 0;
    overflow: visible;
    z-index: 10;
  }
  .cgmini-photo {
    position: absolute;
    left: 7px;
    top: -15px;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 5px solid #0f2d75;
    background: rgba(255,255,255,0.15);
    z-index: 5;
  }
  .cgmini-header-info { color: #fff; }
  .cgmini-name {
    font-size: 0.62rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #fff;
    margin: 0 0 0.1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cgmini-role {
    font-size: 0.42rem;
    color: #e0e6ff;
    margin: 0;
  }
  .cgmini-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  .cgmini-left {
    width: 32%;
    background: #111111;
    padding: 0.5rem 0.35rem 0.5rem;
    flex-shrink: 0;
    overflow: hidden;
  }
  .cgmini-right {
    width: 68%;
    background: #ffffff;
    padding: 0.5rem 0.5rem 0.5rem;
    overflow: hidden;
  }
  .cgmini-section {
    margin-bottom: 0.45rem;
  }
  .cgmini-section h3 {
    font-size: 0.38rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #ffffff;
    border-bottom: 1px solid rgba(255,255,255,0.25);
    padding-bottom: 2px;
    margin: 0 0 0.2rem;
  }
  .cgmini-right .cgmini-section h3 {
    color: #111111;
    border-bottom: 1px solid #cfcfcf;
  }
  .cgmini-section p,
  .cgmini-section span {
    font-size: 0.36rem;
    color: #ffffff;
    margin: 0 0 0.1rem;
    line-height: 1.4;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cgmini-right .cgmini-section p,
  .cgmini-right .cgmini-section span {
    color: #374151;
  }
  .cgmini-skills span {
    color: #ffffff !important;
  }

  /* ‚îÄ‚îÄ Modern-1 / generic mini layout ‚îÄ‚îÄ */
  .m1mini-left {
    width: 37%;
    background: #1e2d4f;
    padding: 0.65rem 0.5rem 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0;
    overflow: hidden;
    flex-shrink: 0;
  }

  .m1mini-avatar {
    width: 44px;
    height: 44px;
    border-radius: 6px;
    background: rgba(255,255,255,0.2);
    border: 2px solid #fbbf24;
    margin: 0 auto 0.4rem;
    flex-shrink: 0;
  }

  .m1mini-name {
    font-size: 0.78rem;
    font-weight: 700;
    color: #fff;
    text-align: center;
    line-height: 1.2;
    margin-bottom: 0.1rem;
  }

  .m1mini-role {
    font-size: 0.55rem;
    color: rgba(255,255,255,0.72);
    text-align: center;
    margin-bottom: 0.45rem;
    line-height: 1.3;
  }

  .m1mini-section {
    margin-bottom: 0.35rem;
  }

  /* Left sidebar section headings: yellow text + yellow underline */
  .m1mini-left .m1mini-section h3 {
    font-size: 0.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: #fbbf24;
    border-bottom: 1.5px solid #fbbf24;
    padding-bottom: 0.06rem;
    margin-bottom: 0.15rem;
  }

  .m1mini-left p {
    font-size: 0.5rem;
    color: rgba(255,255,255,0.82);
    margin: 0.05rem 0;
    line-height: 1.35;
    overflow: hidden;
  }

  .m1mini-right {
    flex: 1;
    padding: 0.6rem 0.5rem 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0;
    overflow: hidden;
  }

  /* Right section headings: navy text + yellow underline */
  .m1mini-right .m1mini-section h3 {
    font-size: 0.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: #1e2d4f;
    border-bottom: 1.5px solid #fbbf24;
    padding-bottom: 0.06rem;
    margin-bottom: 0.15rem;
  }

  .m1mini-right p {
    font-size: 0.5rem;
    color: #374151;
    margin: 0;
    line-height: 1.35;
    overflow: hidden;
    max-height: 3.2rem;
    white-space: normal;
    word-wrap: break-word;
  }

  /* Skills: yellow pills matching actual template */
  .m1mini-skills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.15rem;
  }

  .m1mini-skills span {
    background: #fbbf24;
    color: #1e2d4f;
    font-size: 0.45rem;
    font-weight: 600;
    padding: 0.05rem 0.25rem;
    border-radius: 3px;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .bsmini-header {
    display: flex;
    align-items: flex-start;
    gap: 0.55rem;
    padding: 0.65rem 0.75rem 0.5rem;
    flex-shrink: 0;
  }

  .bsmini-photo {
    width: 42px;
    height: 42px;
    border-radius: 5px;
    background: #e5e7eb;
    border: 1px solid #d1d5db;
    flex-shrink: 0;
  }

  .bsmini-header-info {
    flex: 1;
    min-width: 0;
  }

  .bsmini-name {
    font-size: 0.85rem;
    font-weight: 700;
    color: #111827;
    line-height: 1.2;
    margin-bottom: 0.05rem;
  }

  .bsmini-role {
    font-size: 0.65rem;
    color: #6b7280;
    margin-bottom: 0.2rem;
  }

  .bsmini-contact {
    display: flex;
    flex-wrap: wrap;
    gap: 0.05rem 0.5rem;
    font-size: 0.54rem;
    color: #374151;
    line-height: 1.4;
  }

  .bsmini-divider {
    height: 1.5px;
    background: #111827;
    margin: 0 0.75rem;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Body: two columns ‚îÄ‚îÄ */
  .bsmini-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Footer strip (Languages + Reference indicator) ‚îÄ‚îÄ */
  .bsmini-footer {
    display: flex;
    justify-content: space-around;
    background: #f3f4f6;
    border-top: 1px solid #d1d5db;
    padding: 0.2rem 0.4rem;
    font-size: 0.38rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    color: #6b7280;
    flex-shrink: 0;
  }

  .bsmini-left {
    width: 35%;
    padding: 0.5rem 0.45rem 0.5rem 0.75rem;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    overflow: hidden;
  }

  .bsmini-right {
    flex: 1;
    padding: 0.5rem 0.75rem 0.5rem 0.45rem;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Section heading ‚îÄ‚îÄ */
  .bsmini-section {
    margin-bottom: 0.45rem;
  }

  .bsmini-section h3 {
    font-size: 0.56rem;
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: #111827;
    border-bottom: 1px solid #111827;
    padding-bottom: 0.1rem;
    margin-bottom: 0.2rem;
  }

  .bsmini-section p {
    font-size: 0.58rem;
    line-height: 1.38;
    color: #374151;
    margin: 0;
    overflow: hidden;
    max-height: 3.5rem;
    word-wrap: break-word;
    white-space: normal;
  }

  /* ‚îÄ‚îÄ Skills: plain bullet list in the mini preview ‚îÄ‚îÄ */
  .modern-mini-skills {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }

  .modern-mini-skills span {
    font-size: 0.56rem;
    color: #374151;
    line-height: 1.3;
    padding-left: 0.6rem;
    position: relative;
  }

  .modern-mini-skills span::before {
    content: "‚Ä¢";
    position: absolute;
    left: 0;
    color: #6b7280;
  }

  /* ‚îÄ‚îÄ Tech-Focused mini preview ‚îÄ‚îÄ */
  .modern-mini-page.tf-mode {
    flex-direction: column;
    background: #ffffff;
  }

  .tfmini-header {
    background: #0f172a;
    border-top: 3px solid #3b82f6;
    padding: 0.5rem 0.6rem;
    display: flex;
    align-items: center;
    gap: 0.45rem;
    flex-shrink: 0;
    position: relative;
  }

  .tfmini-photo {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: rgba(59,130,246,0.2);
    border: 2px solid rgba(59,130,246,0.4);
    flex-shrink: 0;
  }

  .tfmini-header-info {
    flex: 1;
    min-width: 0;
  }

  .tfmini-name {
    font-size: 0.72rem;
    font-weight: 700;
    color: #f8fafc;
    line-height: 1.1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .tfmini-role {
    font-size: 0.5rem;
    color: #93c5fd;
    margin: 0.05rem 0 0.15rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .tfmini-contact {
    display: flex;
    flex-wrap: wrap;
    gap: 0.1rem 0.4rem;
  }

  .tfmini-contact span {
    font-size: 0.42rem;
    color: #cbd5e1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 90px;
  }

  .tfmini-links {
    margin-top: 0.08rem;
  }

  .tfmini-links span {
    font-size: 0.42rem;
    color: #60a5fa;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 110px;
  }

  .tfmini-qr-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.05rem;
    flex-shrink: 0;
  }

  .tfmini-qr-sq {
    width: 28px;
    height: 28px;
    border-radius: 3px;
    background: repeating-linear-gradient(
      0deg,
      rgba(59,130,246,0.15) 0px,
      rgba(59,130,246,0.15) 3px,
      transparent 3px,
      transparent 6px
    ),
    repeating-linear-gradient(
      90deg,
      rgba(59,130,246,0.15) 0px,
      rgba(59,130,246,0.15) 3px,
      transparent 3px,
      transparent 6px
    );
    border: 1px solid rgba(59,130,246,0.35);
  }

  .tfmini-qr-label {
    font-size: 0.36rem;
    color: #64748b;
    letter-spacing: 0.05em;
  }

  .tfmini-summary-band {
    background: #1e293b;
    padding: 0.3rem 0.6rem;
    flex-shrink: 0;
  }

  .tfmini-band-label {
    font-size: 0.38rem;
    font-weight: 700;
    color: #60a5fa;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 0.1rem;
  }

  .tfmini-summary-band p {
    font-size: 0.48rem;
    color: #cbd5e1;
    line-height: 1.4;
    margin: 0;
    overflow: hidden;
    max-height: 2.5rem;
    word-wrap: break-word;
    white-space: normal;
  }

  .tfmini-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  .tfmini-left {
    width: 34%;
    background: #f1f5f9;
    padding: 0.4rem 0.35rem;
    border-right: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    overflow: hidden;
  }

  .tfmini-right {
    flex: 1;
    padding: 0.4rem 0.45rem;
    overflow: hidden;
  }

  .tfmini-section {
    margin-bottom: 0.35rem;
  }

  .tfmini-section h3 {
    font-size: 0.44rem;
    font-weight: 700;
    letter-spacing: 0.09em;
    text-transform: uppercase;
    color: #3b82f6;
    border-bottom: 1px solid #bfdbfe;
    padding-bottom: 0.08rem;
    margin-bottom: 0.18rem;
    display: flex;
    align-items: center;
    gap: 0.2rem;
  }

  .tfmini-section h3::before {
    content: '';
    display: inline-block;
    width: 6px;
    height: 1.5px;
    background: #3b82f6;
    border-radius: 1px;
    flex-shrink: 0;
  }

  .tfmini-section p,
  .tfmini-section .tfmini-placeholder {
    font-size: 0.46rem;
    line-height: 1.38;
    color: #374151;
    margin: 0;
    overflow: hidden;
    max-height: 2.8rem;
    word-wrap: break-word;
    white-space: normal;
  }

  .tfmini-placeholder {
    color: #9ca3af;
  }

  .tfmini-tech-content {
    display: flex;
    flex-wrap: wrap;
    gap: 0.12rem;
    overflow: hidden;
    max-height: 3rem;
  }

  .tfmini-tech-tag {
    font-size: 0.4rem;
    background: #eff6ff;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
    border-radius: 2px;
    padding: 0.05rem 0.22rem;
    white-space: nowrap;
  }

  .tfmini-right .tfmini-section p {
    color: #374151;
    max-height: 3.5rem;
  }

  #pvExperience {
    font-size: 0.58rem;
    line-height: 1.38;
    color: #374151;
    margin: 0;
    overflow: hidden;
    white-space: normal;
    word-wrap: break-word;
  }

  @media (max-width: 1024px) {
    .builder-main {
      flex-direction: column;
    }

    .builder-right {
      position: static;
      width: 100%;
    }

    .modern-mini-page {
      margin: 1rem auto 0;
    }
  }

  /* ===== AI Interview Button ===== */
  .btn-ai-interview {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 14px rgba(99,102,241,0.35);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    white-space: nowrap;
  }
  .btn-ai-interview:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 18px rgba(99,102,241,0.45);
  }

  /* ===== AI Interview Modal ===== */
  .ai-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .ai-modal {
    background: #fff;
    border-radius: 20px;
    width: 100%;
    max-width: 540px;
    max-height: 88vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 60px rgba(0,0,0,0.25);
    overflow: hidden;
  }

  .ai-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1.25rem 1.5rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    flex-shrink: 0;
  }

  .ai-modal-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 0.2rem;
  }

  .ai-modal-subtitle {
    font-size: 0.85rem;
    color: #6b7280;
    margin: 0;
  }

  .ai-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    line-height: 1;
    padding: 0 0.25rem;
    flex-shrink: 0;
  }
  .ai-modal-close:hover { color: #111827; }

  .ai-chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    min-height: 180px;
  }

  .ai-bubble {
    max-width: 82%;
    padding: 0.6rem 0.9rem;
    border-radius: 14px;
    font-size: 0.88rem;
    line-height: 1.5;
  }

  .ai-bubble.bot {
    background: #f3f4f6;
    color: #111827;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  .ai-bubble.user {
    background: #6366f1;
    color: #fff;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }

  .ai-input-row {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-top: 1px solid #e5e7eb;
    flex-shrink: 0;
  }

  .ai-answer-input {
    flex: 1;
    padding: 0.55rem 0.8rem;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    font-size: 0.9rem;
    background: #f9fafb;
    outline: none;
    transition: border-color 0.15s;
  }
  .ai-answer-input:focus {
    border-color: #6366f1;
    background: #fff;
    box-shadow: 0 0 0 1px rgba(99,102,241,0.3);
  }

  /* Input wrapper (input + mic button) */
  .ai-input-wrapper {
    position: relative;
    flex: 1;
    display: flex;
    align-items: center;
  }
  .ai-input-wrapper .ai-answer-input {
    flex: none;
    width: 100%;
    padding-right: 2.4rem;
  }
  .ai-mic-btn {
    position: absolute;
    right: 0.45rem;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.05rem;
    line-height: 1;
    padding: 0.2rem 0.25rem;
    border-radius: 6px;
    color: #9ca3af;
    transition: color 0.15s, background 0.15s;
  }
  .ai-mic-btn:hover:not(:disabled) {
    background: #f3f4f6;
    color: #374151;
  }
  .ai-mic-btn.recording {
    color: #ef4444;
    animation: mic-pulse 0.8s ease-in-out infinite;
  }
  .ai-mic-btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }
  @keyframes mic-pulse {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.45; }
  }
  .ai-mic-listening {
    font-size: 0.72rem;
    color: #ef4444;
    padding: 0 1.25rem 0.3rem;
    display: none;
  }
  .ai-mic-listening.visible {
    display: block;
  }

  .ai-generate-row {
    padding: 0.75rem 1.25rem;
    border-top: 1px solid #e5e7eb;
    text-align: center;
    flex-shrink: 0;
  }

  .ai-generate-btn {
    width: 100%;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border: none;
    border-radius: 10px;
  }
  .ai-generate-btn:hover { opacity: 0.92; }

  .ai-modal-status {
    padding: 0 1.25rem 0.75rem;
    font-size: 0.82rem;
    color: #6b7280;
    text-align: center;
    min-height: 1.2rem;
    flex-shrink: 0;
  }

  /* ===== Photo Upload Widget (builder Step 1) ===== */
  .rb-photo-field { display: flex; flex-direction: column; gap: 0.55rem; }
  .rb-photo-badge {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 600;
    color: #7c3aed;
    background: #ede9fe;
    border-radius: 999px;
    padding: 0.1rem 0.5rem;
    margin-left: 0.4rem;
    vertical-align: middle;
  }
  .photo-preview-wrap {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 2px dashed #d1d5db;
    overflow: hidden;
    background: #f9fafb;
    position: relative;
    flex-shrink: 0;
  }
  .photo-preview-img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .photo-preview-img.ph-hidden { display: none; }
  .photo-preview-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    font-size: 0.7rem;
    color: #9ca3af;
    text-align: center;
  }
  .photo-preview-placeholder.ph-hidden { display: none; }
  .photo-upload-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
  .btn-photo-action {
    font-size: 0.8rem;
    padding: 0.3rem 0.7rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #f9fafb;
    cursor: pointer;
    font-weight: 500;
    color: #374151;
    transition: background 0.15s;
  }
  .btn-photo-action:hover { background: #f3f4f6; }
  .btn-photo-remove { color: #ef4444; border-color: #fca5a5; }
  .btn-photo-remove:hover { background: #fef2f2; }
  .btn-photo-remove.ph-hidden { display: none; }

  /* ===== AI Interview Photo Step (Part 3) ===== */
  .ai-photo-step {
    padding: 0.75rem 1.25rem 0.75rem;
    border-top: 1px solid #e5e7eb;
    flex-shrink: 0;
  }
  .ai-photo-initial {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }
  .ai-photo-choose-btn { font-size: 0.9rem; }
  .ai-photo-skip-link {
    background: none;
    border: none;
    color: #6b7280;
    font-size: 0.85rem;
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
  }
  .ai-photo-skip-link:hover { color: #374151; }
  .ai-crop-panel {
    background: #f9fafb;
    border-radius: 8px;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
  }
  .ai-crop-frame {
    max-height: 240px;
    overflow: hidden;
    border-radius: 6px;
    background: #111827;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .ai-crop-frame img { max-width: 100%; display: block; }
  .ai-crop-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.6rem;
    align-items: center;
    flex-wrap: wrap;
  }
  .ai-photo-done-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.65rem;
  }
  .ai-photo-thumb {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #d1d5db;
    flex-shrink: 0;
  }
  .ai-photo-done-label {
    font-size: 0.9rem;
    color: #16a34a;
    font-weight: 600;
    flex: 1;
  }

  @media (max-width: 768px) {
    .builder-header-row {
      flex-direction: column;
      align-items: flex-start;
    }

    .rb-step {
      padding: 1.3rem 1.5rem;
    }

    .rb-grid-2 {
      grid-template-columns: 1fr;
    }

    .rb-nav {
      flex-direction: row;
      gap: 0.75rem;
    }
  }
</style>

<script>
  (function () {
    const steps = Array.from(document.querySelectorAll(".rb-step"));
    const dots = Array.from(document.querySelectorAll(".rb-step-dot"));
    const backBtn = document.getElementById("rbBackBtn");
    const nextBtn = document.getElementById("rbNextBtn");
    const submitBtn = document.getElementById("rbSubmitBtn");
    const stepCounter = document.getElementById("rbStepCounter");

    let current = 0;

    function updateUI() {
      steps.forEach((step, i) => {
        step.classList.toggle("active", i === current);
      });

      dots.forEach((dot, i) => {
        dot.classList.toggle("active", i === current);
        dot.classList.toggle("done", i < current);
      });

      backBtn.disabled = current === 0;
      backBtn.classList.toggle("btn-ghost-disabled", current === 0);

      if (current === steps.length - 1) {
        nextBtn.style.display = "none";
        submitBtn.style.display = "inline-block";
      } else {
        nextBtn.style.display = "inline-block";
        submitBtn.style.display = "none";
      }

      if (stepCounter) {
        stepCounter.textContent = current + 1;
      }
    }

    backBtn.addEventListener("click", () => {
      if (current > 0) {
        current--;
        updateUI();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (current < steps.length - 1) {
        current++;
        updateUI();
      }
    });

    // Auto-expand textareas
    const textareas = document.querySelectorAll(".rb-field textarea");
    function autoResize(el) {
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    }
    textareas.forEach((ta) => {
      autoResize(ta);
      ta.addEventListener("input", () => autoResize(ta));
    });

    updateUI();

    // ===== MINI LIVE PREVIEW BINDINGS =====
    function nl2br(text) {
      return (text || "").replace(/\n/g, "<br>");
    }

    function bindText(inputId, previewId, placeholder, multiline) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      if (!input || !preview) return;

      function sync() {
        const val = input.value.trim();
        if (!val) {
          if (multiline) {
            preview.innerHTML = placeholder;
          } else {
            preview.textContent = placeholder;
          }
        } else if (multiline) {
          preview.innerHTML = nl2br(val);
        } else {
          preview.textContent = val;
        }
      }

      input.addEventListener("input", sync);
      sync(); // initial
    }

    bindText("fullName", "pvName", "Your Name", false);
    bindText("roleTitle", "pvRole", "Your Job Title", false);

    bindText("email", "pvEmail", "email@example.com", false);
    bindText("phone", "pvPhone", "+91 0000000000", false);
    bindText("location", "pvLocation", "City, Country", false);

    bindText("summary", "pvSummary", "Your concise professional summary will appear here.", true);
    bindText("experience", "pvExperience", "Your experience lines will appear here as you type.", true);
    bindText("education", "pvEducation", "Your education entries will appear here.", true);
    bindText("languages", "pvLanguages", "Languages will appear here.", true);

    // special binding for skills as yellow pills
    function bindSkillsPills() {
      const input = document.getElementById("skills");
      const container = document.getElementById("pvSkills");
      if (!input || !container) return;

      function sync() {
        const val = input.value.trim();
        container.innerHTML = "";

        if (!val) {
          const span = document.createElement("span");
          span.textContent = "Skills will appear here.";
          container.appendChild(span);
          return;
        }

        val
          .split(/\r?\n+/)
          .map(line => line.replace(/^\s*[-*‚Ä¢]\s*/, "").trim())
          .filter(Boolean)
          .forEach(line => {
            const pill = document.createElement("span");
            pill.textContent = line;
            container.appendChild(pill);
          });
      }

      input.addEventListener("input", sync);
      sync();
    }

    bindSkillsPills();

    // === TECH-FOCUSED: live bindings for tech-specific fields ===
    // bindText handles missing elements gracefully (returns early if null)
    bindText("certifications", "pvCertifications", "Certifications will appear here.", true);
    bindText("projects", "pvProjects", "Projects will appear here.", true);

    // portfolioUrl ‚Üí show stripped URL
    (function () {
      const input = document.getElementById("portfolioUrl");
      const preview = document.getElementById("pvPortfolioUrl");
      if (!input || !preview) return;
      function sync() {
        const val = input.value.trim().replace(/^https?:\/\//, "");
        preview.textContent = val || "portfolio.com";
      }
      input.addEventListener("input", sync);
      sync();
    })();

    // technologies ‚Üí render as blue mini tags grouped by category
    (function () {
      const input = document.getElementById("technologies");
      const container = document.getElementById("pvTechnologies");
      if (!input || !container) return;
      function sync() {
        const val = input.value.trim();
        container.innerHTML = "";
        if (!val) {
          const span = document.createElement("span");
          span.className = "tfmini-placeholder";
          span.textContent = "Technologies will appear here.";
          container.appendChild(span);
          return;
        }
        val.split(/\r?\n+/).map(l => l.trim()).filter(Boolean).forEach(line => {
          const ci = line.indexOf(":");
          const skillsStr = ci === -1 ? line : line.slice(ci + 1);
          skillsStr.split(",").map(s => s.trim()).filter(Boolean).forEach(skill => {
            const tag = document.createElement("span");
            tag.className = "tfmini-tech-tag";
            tag.textContent = skill;
            container.appendChild(tag);
          });
        });
      }
      input.addEventListener("input", sync);
      sync();
    })();

    // === AUTO-SCALE MINI PREVIEW TO FIT COLUMN WIDTH ===
    function setupMiniScaling() {
      const preview = document.querySelector(".modern-mini-preview");
      const page = document.querySelector(".modern-mini-page");
      if (!preview || !page) return;

      const BASE_WIDTH = 420; // must match CSS width

      function applyScale() {
        const containerWidth = preview.clientWidth;
        if (!containerWidth) return;

        const scale = Math.min(1, containerWidth / BASE_WIDTH);
        page.style.transform = "scale(" + scale + ")";
        page.style.transformOrigin = "top center";

        const scaledHeight = page.offsetHeight * scale;
        preview.style.height = scaledHeight + "px";
      }

      window.addEventListener("resize", applyScale);
      applyScale();
    }

        // ===== SAVE DRAFT (manual + auto) =====
    const form = document.getElementById("resumeBuilderForm");
    const saveBtn = document.getElementById("rbSaveBtn");
    const resumeIdInput = document.getElementById("resumeId");

    let autoSaveTimer = null;

    async function saveResume(isAuto = false) {
      if (!form) return;

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      if (!isAuto && saveBtn) {
        saveBtn.disabled = true;
        var originalText = saveBtn.textContent;
        saveBtn.textContent = "Saving...";
      }

      try {
        const res = await fetch("/resume/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        let data;
        try {
          data = await res.json();
        } catch (e) {
          throw new Error("Non-JSON response from server");
        }

        if (data.success) {
          if (resumeIdInput) {
            resumeIdInput.value = data.resumeId;
          }
          if (!isAuto) {
            alert("Resume saved!");
          }
        } else {
          if (!isAuto) {
            alert(data.error || "Failed to save resume.");
          } else {
            console.warn("Auto-save failed:", data.error);
          }
        }
      } catch (err) {
        console.error("Error saving resume:", err);
        if (!isAuto) {
          alert("Something went wrong while saving.");
        }
      } finally {
        if (!isAuto && saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
      }
    }

    // Manual save
    if (saveBtn) {
      saveBtn.addEventListener("click", () => {
        saveResume(false);
      });
    }

    // Auto-save: 5 seconds after user stops typing
    if (form) {
      const watchedSelectors = "input[type='text'], input[type='email'], textarea";
      const watchedFields = form.querySelectorAll(watchedSelectors);

      watchedFields.forEach((el) => {
        el.addEventListener("input", () => {
          if (autoSaveTimer) clearTimeout(autoSaveTimer);
          autoSaveTimer = setTimeout(() => {
            saveResume(true);
          }, 5000); // 5 seconds of inactivity
        });
      });
    }
    setupMiniScaling();
  })();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Sync experience level from localStorage into hidden form field
  const expLevelInput = document.getElementById("experienceLevelInput");
  if (expLevelInput) {
    expLevelInput.value = localStorage.getItem("experienceLevel") || "experienced";
  }

  const aiButtons = document.querySelectorAll(".ai-btn");
  const roleInput = document.getElementById("roleTitle");

  // Store last AI operation per field for undo
  const lastAIStates = {}; // { field: { before, after } }

  aiButtons.forEach((btn) => {
    const field = btn.dataset.field;
    const textarea = document.getElementById(field);
    const undoBtn = document.querySelector(
      `.ai-undo-btn[data-field="${field}"]`
    );

    if (!textarea) return;

    // --- AI Suggest click ---
    btn.addEventListener("click", async () => {
      const currentText = textarea.value.trim();
      const roleTitle = roleInput ? roleInput.value : "";

      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = "‚è≥ Thinking...";

      if (undoBtn) undoBtn.disabled = true;

      try {
        const res = await fetch("/api/ai/suggest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            field,
            currentText,
            roleTitle,
            experience: (document.getElementById("experience") || {}).value || "",
          }),
        });

        const data = await res.json();
        if (data.success && data.text) {
          const before = textarea.value;
          let combined;

          if (field === "experience") {
            // Structured result: replace the whole field (it IS the full experience)
            combined = data.text.trim();

            // Persist structured array in hidden experienceJson input
            let hiddenExp = document.getElementById("experienceJson");
            if (!hiddenExp) {
              hiddenExp = document.createElement("input");
              hiddenExp.type = "hidden";
              hiddenExp.name = "experienceJson";
              hiddenExp.id   = "experienceJson";
              document.getElementById("resumeBuilderForm").appendChild(hiddenExp);
            }
            const prevStructured = hiddenExp.value;
            hiddenExp.value = JSON.stringify(data.structured || []);
            lastAIStates[field] = { before, after: combined, prevStructured };
          } else {
            // All other fields: append suggestion to existing content
            const existing   = textarea.value.trim();
            const suggestion = data.text.trim();
            combined = existing ? existing + "\n\n" + suggestion : suggestion;
            lastAIStates[field] = { before, after: combined };
          }

          // Skills: normalise comma-separated list ‚Üí one skill per line
          if (field === "skills") {
            combined = combined
              .split(/,\s*/)
              .map(s => s.trim())
              .filter(Boolean)
              .join("\n");
          }

          textarea.value = combined;
          textarea.dispatchEvent(new Event("input")); // auto-resize + autosave

          if (undoBtn) {
            undoBtn.disabled = false;
          }

          textarea.style.background = "#e0ffe0";
          setTimeout(() => (textarea.style.background = "white"), 1200);
        } else {
          if (data.error === "insufficient_quota") {
            alert("‚ö†Ô∏è AI helper is temporarily unavailable (quota finished). Please check your API key or try later.");
          } else {
            alert("‚ö†Ô∏è Could not generate suggestion. Try again.");
          }
        }
      } catch (err) {
        console.error(err);
        alert("Error contacting AI helper.");
      } finally {
        btn.textContent = oldText;
        btn.disabled = false;
      }
    });

    // --- Undo click ---
    if (undoBtn) {
      undoBtn.addEventListener("click", () => {
        const state = lastAIStates[field];
        if (!state) return;

        textarea.value = state.before;
        textarea.dispatchEvent(new Event("input")); // keep autosave + preview in sync

        // Restore experienceJson to its pre-suggestion value
        if (field === "experience") {
          const hiddenExp = document.getElementById("experienceJson");
          if (hiddenExp) hiddenExp.value = state.prevStructured || "";
        }

        delete lastAIStates[field];
        undoBtn.disabled = true;

        textarea.style.background = "#fee2e2";
        setTimeout(() => (textarea.style.background = "white"), 800);
      });
    }
  });
});
</script>

<script>
/* ============================================================
   AI INTERVIEW MODE
   - Asks questions one-by-one in a chat UI
   - Sends answers to /api/ai/interview-generate (Gemini)
   - Auto-fills the resume builder form with the result
   ============================================================ */
(function () {
  const TEMPLATE_ID = "<%= template %>";
  // Templates that support a profile photo (must match config/template-fields.js)
  const IS_PHOTO_TEMPLATE = ["modern-1", "bold-sidebar", "creative-gradient"].includes(TEMPLATE_ID);

  // DOM refs ‚Äî Q&A UI
  const openBtn    = document.getElementById("aiInterviewBtn");
  const modal      = document.getElementById("aiInterviewModal");
  const closeBtn   = document.getElementById("aiModalClose");
  const chatArea   = document.getElementById("aiChatArea");
  const inputRow   = document.getElementById("aiInputRow");
  const answerInput= document.getElementById("aiAnswerInput");
  const sendBtn    = document.getElementById("aiSendBtn");
  const genRow     = document.getElementById("aiGenerateRow");
  const genBtn     = document.getElementById("aiGenerateBtn");
  const statusEl   = document.getElementById("aiModalStatus");
  const micBtn     = document.getElementById("aiMicBtn");
  const micStatus  = document.getElementById("aiMicStatus");
  // DOM refs ‚Äî Photo step
  const photoStep       = document.getElementById("aiPhotoStep");
  const aiPhotoInput    = document.getElementById("aiPhotoInput");
  const aiPhotoInitial  = document.getElementById("aiPhotoInitial");
  const aiPhotoChooseBtn= document.getElementById("aiPhotoChooseBtn");
  const aiPhotoSkipBtn  = document.getElementById("aiPhotoSkipBtn");
  const aiCropPanel     = document.getElementById("aiCropPanel");
  const aiCropImg       = document.getElementById("aiCropImg");
  const aiCropConfirmBtn= document.getElementById("aiCropConfirmBtn");
  const aiCropRetryBtn  = document.getElementById("aiCropRetryBtn");
  const aiPhotoDoneArea = document.getElementById("aiPhotoDoneArea");
  const aiPhotoThumb    = document.getElementById("aiPhotoThumb");
  const aiPhotoRedo     = document.getElementById("aiPhotoRedo");
  const aiPhotoGenBtn   = document.getElementById("aiPhotoGenBtn");

  // State
  let questions = [];     // [{key, question}] fetched from /api/template-fields
  let qIndex    = 0;      // current question index
  const answers = {};     // { key: "user answer" }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addBubble(text, role) {
    const div = document.createElement("div");
    div.className = "ai-bubble " + role;
    div.textContent = text;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function setStatus(msg) {
    if (statusEl) statusEl.textContent = msg;
  }

  function resetModal() {
    chatArea.innerHTML = "";
    Object.keys(answers).forEach(k => delete answers[k]);
    qIndex = 0;
    answerInput.value = "";
    inputRow.style.display = "flex";
    genRow.style.display = "none";
    if (photoStep) photoStep.style.display = "none";
    setStatus("");
  }

  // ‚îÄ‚îÄ Open modal & fetch questions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function openModal() {
    resetModal();
    modal.style.display = "flex";
    answerInput.disabled = true;
    sendBtn.disabled = true;
    setStatus("Loading questions‚Ä¶");

    try {
      const res = await fetch("/api/template-fields/" + TEMPLATE_ID);
      const data = await res.json();
      // Only keep fields that have a question string
      questions = (data.fields || []).filter(f => f.question);
    } catch (e) {
      addBubble("Sorry, couldn't load questions. Please try again.", "bot");
      setStatus("");
      return;
    }

    if (!questions.length) {
      addBubble("No interview questions found for this template.", "bot");
      setStatus("");
      return;
    }

    setStatus("");
    answerInput.disabled = false;
    sendBtn.disabled = false;

    addBubble("Hi! I'm your AI resume assistant. I'll ask you a few quick questions and build your resume. Let's start!", "bot");
    setTimeout(() => askQuestion(0), 400);
  }

  function askQuestion(index) {
    if (index >= questions.length) {
      showGenerateButton();
      return;
    }
    const q = questions[index];
    addBubble(q.question, "bot");
    answerInput.focus();
  }

  function showGenerateButton() {
    inputRow.style.display = "none";
    if (IS_PHOTO_TEMPLATE) {
      photoStep.style.display = "block";
      aiPhotoInitial.style.display = "flex";
      aiCropPanel.style.display = "none";
      aiPhotoDoneArea.style.display = "none";
      addBubble("Almost done! Your template supports a profile photo. Would you like to add one?", "bot");
    } else {
      genRow.style.display = "block";
      addBubble("Great! I have everything I need. Click the button below to generate your resume.", "bot");
    }
  }

  // ‚îÄ‚îÄ Send answer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function sendAnswer() {
    const val = answerInput.value.trim();
    if (!val) return;

    const q = questions[qIndex];
    addBubble(val, "user");
    answers[q.key] = val;
    answerInput.value = "";

    qIndex++;
    setTimeout(() => askQuestion(qIndex), 300);
  }

  sendBtn.addEventListener("click", sendAnswer);
  answerInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendAnswer(); }
  });

  // ‚îÄ‚îÄ Generate resume (shared by genBtn and aiPhotoGenBtn) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function doGenerate(btn) {
    btn.disabled   = true;
    btn.textContent = "‚è≥ Generating‚Ä¶";
    setStatus("Gemini is crafting your resume‚Ä¶");
    try {
      const res  = await fetch("/api/ai/interview-generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers, templateId: TEMPLATE_ID }),
      });
      const data = await res.json();
      if (!data.success || !data.data) {
        setStatus("‚ö†Ô∏è " + (data.error === "insufficient_quota"
          ? "AI quota reached. Please try again later."
          : (data.error || "Something went wrong.")));
        btn.disabled   = false;
        btn.textContent = "‚ú® Generate My Resume";
        return;
      }
      // Merge photo URL captured during the photo step
      if (answers.profileImageUrl) data.data.profileImageUrl = answers.profileImageUrl;
      fillForm(data.data);
      modal.style.display = "none";
    } catch (err) {
      console.error(err);
      setStatus("‚ö†Ô∏è Network error. Please try again.");
      btn.disabled   = false;
      btn.textContent = "‚ú® Generate My Resume";
    }
  }
  genBtn.addEventListener("click", () => doGenerate(genBtn));

  // ‚îÄ‚îÄ fillForm: populate all form fields with AI-generated data ‚îÄ‚îÄ
  function expArrayToText(arr) {
    if (!Array.isArray(arr)) return String(arr || "");
    return arr.map(item => {
      const header = "- " + [item.title, item.company ? "[" + item.company + "]" : "", item.dates ? "(" + item.dates + ")" : ""].filter(Boolean).join(" ");
      return item.description ? header + "\n" + item.description : header;
    }).join("\n\n");
  }

  function setField(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = value || "";
    el.dispatchEvent(new Event("input")); // triggers auto-resize + live preview + autosave
  }

  function fillForm(resumeData) {
    setField("fullName",       resumeData.fullName);
    setField("roleTitle",      resumeData.roleTitle);
    setField("phone",          resumeData.phone);
    setField("email",          resumeData.email);
    setField("location",       resumeData.location);
    setField("summary",        resumeData.summary);
    setField("education",      resumeData.education);
    setField("skills",         resumeData.skills);
    setField("languages",      resumeData.languages);

    // Experience: convert array to textarea text format
    const expText = expArrayToText(resumeData.experience);
    setField("experience", expText);

    // Profile photo ‚Äî set hidden input + update preview widget if present
    if (resumeData.profileImageUrl) {
      const hiddenPhoto = document.getElementById("profileImageUrl");
      if (hiddenPhoto) hiddenPhoto.value = resumeData.profileImageUrl;
      const previewImg   = document.getElementById("photoPreviewImg");
      const placeholder  = document.getElementById("photoPlaceholder");
      const removeBtn    = document.getElementById("photoRemoveBtn");
      if (previewImg)  { previewImg.src = resumeData.profileImageUrl; previewImg.classList.remove("ph-hidden"); }
      if (placeholder)   placeholder.classList.add("ph-hidden");
      if (removeBtn)     removeBtn.classList.remove("ph-hidden");
    }

    // Also store the raw JSON for structured save/PDF
    let hiddenExp = document.getElementById("experienceJson");
    if (!hiddenExp) {
      hiddenExp = document.createElement("input");
      hiddenExp.type = "hidden";
      hiddenExp.name = "experienceJson";
      hiddenExp.id   = "experienceJson";
      document.getElementById("resumeBuilderForm").appendChild(hiddenExp);
    }
    hiddenExp.value = JSON.stringify(resumeData.experience);

    // Navigate to step 1 so user can review
    const firstStep = document.querySelector(".rb-step[data-step='1']");
    if (firstStep) {
      document.querySelectorAll(".rb-step").forEach(s => s.classList.remove("active"));
      firstStep.classList.add("active");
      document.querySelectorAll(".rb-step-dot").forEach((d, i) => {
        d.classList.toggle("active", i === 0);
        d.classList.toggle("done", false);
      });
      const counter = document.getElementById("rbStepCounter");
      if (counter) counter.textContent = "1";
      const nextBtn = document.getElementById("rbNextBtn");
      const submitBtn = document.getElementById("rbSubmitBtn");
      if (nextBtn) nextBtn.style.display = "inline-block";
      if (submitBtn) submitBtn.style.display = "none";
    }
  }

  // ‚îÄ‚îÄ AI Interview Photo Step (Part 3) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let cropperInstance = null;

  // Lazy-load Cropper.js from CDN only when the photo step is first used
  function loadCropperJs(cb) {
    if (window.Cropper) { cb(); return; }
    const link   = document.createElement("link");
    link.rel     = "stylesheet";
    link.href    = "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css";
    document.head.appendChild(link);
    const script  = document.createElement("script");
    script.src    = "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js";
    script.onload = cb;
    document.head.appendChild(script);
  }

  function openCropperWithSrc(src) {
    aiCropImg.src = src;
    aiPhotoInitial.style.display = "none";
    aiPhotoDoneArea.style.display = "none";
    aiCropPanel.style.display = "block";
    if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
    cropperInstance = new Cropper(aiCropImg, {
      aspectRatio:        1,        // square crop
      viewMode:           1,        // restrict crop box to canvas
      dragMode:          "move",    // drag the image, not the crop box
      autoCropArea:       0.85,
      guides:             true,
      highlight:          false,
      cropBoxMovable:     true,
      cropBoxResizable:   true,
      toggleDragModeOnDblclick: false,
    });
  }

  if (aiPhotoChooseBtn) {
    aiPhotoChooseBtn.addEventListener("click", () => aiPhotoInput && aiPhotoInput.click());
  }

  if (aiPhotoInput) {
    aiPhotoInput.addEventListener("change", () => {
      const file = aiPhotoInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => loadCropperJs(() => openCropperWithSrc(e.target.result));
      reader.readAsDataURL(file);
      aiPhotoInput.value = ""; // reset so same file can be reselected
    });
  }

  if (aiCropRetryBtn) {
    aiCropRetryBtn.addEventListener("click", () => {
      if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
      aiCropPanel.style.display = "none";
      aiPhotoInitial.style.display = "flex";
    });
  }

  if (aiCropConfirmBtn) {
    aiCropConfirmBtn.addEventListener("click", async () => {
      if (!cropperInstance) return;
      aiCropConfirmBtn.disabled = true;
      aiCropConfirmBtn.textContent = "Uploading‚Ä¶";
      const canvas = cropperInstance.getCroppedCanvas({ width: 400, height: 400 });
      canvas.toBlob(async (blob) => {
        const fd = new FormData();
        fd.append("photo", blob, "profile-photo.jpg");
        try {
          const res  = await fetch("/resume-builder/upload-photo", { method: "POST", body: fd });
          const data = await res.json();
          if (data.success) {
            answers.profileImageUrl = data.imagePath;
            if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
            aiCropPanel.style.display = "none";
            aiPhotoThumb.src = data.imagePath;
            aiPhotoDoneArea.style.display = "block";
            addBubble("Photo uploaded ‚úì  Now let's generate your resume!", "bot");
          } else {
            setStatus("Upload failed ‚Äî try again or skip.");
            aiCropConfirmBtn.disabled = false;
            aiCropConfirmBtn.textContent = "‚úì Use This Photo";
          }
        } catch (err) {
          console.error(err);
          setStatus("Upload error ‚Äî check your connection.");
          aiCropConfirmBtn.disabled = false;
          aiCropConfirmBtn.textContent = "‚úì Use This Photo";
        }
      }, "image/jpeg", 0.92);
    });
  }

  if (aiPhotoRedo) {
    aiPhotoRedo.addEventListener("click", () => {
      answers.profileImageUrl = null;
      aiPhotoDoneArea.style.display = "none";
      aiPhotoInitial.style.display = "flex";
    });
  }

  if (aiPhotoSkipBtn) {
    aiPhotoSkipBtn.addEventListener("click", () => {
      addBubble("No photo ‚Äî that's fine!", "bot");
      photoStep.style.display = "none";
      genRow.style.display = "block";
    });
  }

  if (aiPhotoGenBtn) {
    aiPhotoGenBtn.addEventListener("click", () => doGenerate(aiPhotoGenBtn));
  }

  // ‚îÄ‚îÄ Voice Input (continuous mode + 6-second silence buffer) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function initVoiceRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      if (micBtn) {
        micBtn.disabled = true;
        micBtn.title = "Voice input not supported in this browser.";
      }
      return;
    }

    const recognition   = new SR();
    recognition.lang            = "en-IN";
    recognition.continuous      = true;   // don't stop on natural pauses
    recognition.interimResults  = false;  // fire only on final results (cleaner, less noise)
    recognition.maxAlternatives = 3;      // ask for up to 3 candidates; pick highest confidence

    const SILENCE_MS = 7000;  // wait 7 s of silence before finalising
    let isListening    = false;
    let silenceTimer   = null;
    let finalTranscript = "";

    function armSilenceTimer() {
      clearTimeout(silenceTimer);
      silenceTimer = setTimeout(() => {
        if (isListening) {
          micStatus.textContent = "Processing‚Ä¶";
          recognition.stop(); // triggers onend which inserts the transcript
        }
      }, SILENCE_MS);
    }

    recognition.onstart = () => {
      isListening     = true;
      finalTranscript = "";
      micBtn.classList.add("recording");
      micBtn.disabled = false;        // stay clickable so user can stop manually
      micBtn.title    = "Click to stop";
      micStatus.textContent = "Listening‚Ä¶ (pauses are OK)";
      micStatus.classList.add("visible");
      armSilenceTimer(); // auto-stop if completely silent from the start
    };

    recognition.onresult = (e) => {
      // Accumulate only final segments; interim resets the silence timer only.
      // Pick the alternative with the highest confidence score (maxAlternatives=3).
      for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) {
          let best = e.results[i][0];
          for (let a = 1; a < e.results[i].length; a++) {
            if (e.results[i][a].confidence > best.confidence) best = e.results[i][a];
          }
          finalTranscript += best.transcript;
        }
      }
      // Any speech activity ‚Üí reset the silence countdown
      armSilenceTimer();
      micStatus.textContent = "Listening‚Ä¶";
    };

    recognition.onerror = (e) => {
      // "no-speech" fires routinely in continuous mode when the line is quiet ‚Äî ignore
      if (e.error === "no-speech") return;
      clearTimeout(silenceTimer);
      // onend always fires next; it handles the UI reset and transcript insertion
    };

    recognition.onend = () => {
      isListening = false;
      clearTimeout(silenceTimer);
      micBtn.classList.remove("recording");
      micBtn.disabled = false;
      micBtn.title    = "Speak your answer";
      if (finalTranscript.trim()) {
        const existing = answerInput.value.trim();
        answerInput.value = existing
          ? existing + " " + finalTranscript.trim()
          : finalTranscript.trim();
        answerInput.dispatchEvent(new Event("input"));
      }
      micStatus.textContent = "";
      micStatus.classList.remove("visible");
    };

    micBtn.addEventListener("click", () => {
      if (isListening) {
        // User manually stops ‚Äî finalise immediately
        clearTimeout(silenceTimer);
        micStatus.textContent = "Processing‚Ä¶";
        recognition.stop();
        return;
      }
      finalTranscript = "";
      try { recognition.start(); } catch (_) { /* guard double-start */ }
    });
  }
  initVoiceRecognition();

  // ‚îÄ‚îÄ Close modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  closeBtn.addEventListener("click", () => { modal.style.display = "none"; });
  modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });

  // ‚îÄ‚îÄ Open ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  openBtn.addEventListener("click", openModal);
})();
</script>

<script>
/* ‚îÄ‚îÄ Field-level speech-to-text (textarea mic buttons) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(function () {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  // Disable all mic buttons silently if API unavailable
  if (!SR) {
    document.querySelectorAll('.ai-mic-field-btn').forEach(function (btn) {
      btn.disabled = true;
      btn.title = 'Voice input not supported in this browser';
    });
    return;
  }

  const SILENCE_MS = 7000;

  // Shared state ‚Äî only one recording at a time
  var recognition  = null;
  var isListening  = false;
  var activeBtn    = null;
  var activeStatus = null;
  var activeTarget = null;
  var silenceTimer = null;
  var finalTranscript = '';

  function getStatusEl(btn) {
    return btn.closest('.ai-btn-group').querySelector('.fmic-status');
  }

  function armSilenceTimer() {
    clearTimeout(silenceTimer);
    silenceTimer = setTimeout(function () {
      if (isListening && recognition) {
        setStatus('Processing\u2026');
        recognition.stop();
      }
    }, SILENCE_MS);
  }

  function setStatus(text) {
    if (!activeStatus) return;
    activeStatus.textContent = text;
    if (text) activeStatus.classList.add('visible');
    else activeStatus.classList.remove('visible');
  }

  function startRecording(btn, textarea) {
    // Create a fresh instance every time ‚Äî avoids restart-loop bugs
    recognition = new SR();
    recognition.lang            = 'en-IN';
    recognition.continuous      = true;
    recognition.interimResults  = false;  // fire only on final results
    recognition.maxAlternatives = 3;      // pick highest-confidence candidate per segment

    finalTranscript = '';
    activeBtn    = btn;
    activeTarget = textarea;
    activeStatus = getStatusEl(btn);

    recognition.onstart = function () {
      isListening = true;
      activeBtn.classList.add('fmic-recording');
      activeBtn.title = 'Click to stop recording';
      setStatus('Listening\u2026');
      armSilenceTimer();
    };

    recognition.onresult = function (e) {
      for (var i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) {
          var best = e.results[i][0];
          for (var a = 1; a < e.results[i].length; a++) {
            if (e.results[i][a].confidence > best.confidence) best = e.results[i][a];
          }
          finalTranscript += best.transcript;
        }
      }
      // Any speech resets the silence clock
      armSilenceTimer();
      setStatus('Listening\u2026');
    };

    recognition.onerror = function (e) {
      // 'no-speech' fires during silence ‚Äî let the timer handle it
      if (e.error === 'no-speech') return;
      clearTimeout(silenceTimer);
    };

    recognition.onend = function () {
      isListening = false;
      clearTimeout(silenceTimer);

      if (activeBtn) {
        activeBtn.classList.remove('fmic-recording');
        activeBtn.title = 'Voice input';
      }
      setStatus('');

      // Append transcript to the textarea (preserve existing content)
      if (finalTranscript.trim() && activeTarget) {
        var existing = activeTarget.value.trimEnd();
        activeTarget.value = existing
          ? existing + '\n' + finalTranscript.trim()
          : finalTranscript.trim();
        // Notify any live-preview listeners
        activeTarget.dispatchEvent(new Event('input'));
      }

      activeBtn    = null;
      activeStatus = null;
      activeTarget = null;
      recognition  = null;
    };

    try { recognition.start(); } catch (_) { /* guard against double-start */ }
  }

  function stopRecording() {
    clearTimeout(silenceTimer);
    setStatus('Processing\u2026');
    recognition.stop();
  }

  // Wire up every mic button
  document.querySelectorAll('.ai-mic-field-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var targetId = btn.dataset.micTarget;
      var textarea = document.getElementById(targetId);
      if (!textarea) return;

      if (isListening) {
        if (activeBtn === btn) {
          // Same mic: manual stop
          stopRecording();
        } else {
          // Different mic: stop current; user must click again to start new one
          stopRecording();
        }
        return;
      }

      startRecording(btn, textarea);
    });
  });
})();
</script>

<script>
/* ‚îÄ‚îÄ Part 1: Normal form photo upload widget ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(function () {
  const photoInput  = document.getElementById("photoFileInput");
  const photoHidden = document.getElementById("profileImageUrl");
  const previewImg  = document.getElementById("photoPreviewImg");
  const placeholder = document.getElementById("photoPlaceholder");
  const uploadBtn   = document.getElementById("photoUploadTrigger");
  const removeBtn   = document.getElementById("photoRemoveBtn");

  if (!photoInput) return; // not a photo template ‚Äî widget not rendered

  uploadBtn.addEventListener("click", () => photoInput.click());

  photoInput.addEventListener("change", async () => {
    const file = photoInput.files[0];
    if (!file) return;

    const fd = new FormData();
    fd.append("photo", file);
    const originalLabel = uploadBtn.textContent;
    uploadBtn.textContent = "Uploading‚Ä¶";
    uploadBtn.disabled = true;

    try {
      const res  = await fetch("/resume-builder/upload-photo", { method: "POST", body: fd });
      const data = await res.json();
      if (data.success) {
        photoHidden.value = data.imagePath;
        previewImg.src    = data.imagePath;
        previewImg.classList.remove("ph-hidden");
        placeholder.classList.add("ph-hidden");
        removeBtn.classList.remove("ph-hidden");
      }
    } catch (err) {
      console.error("Photo upload failed:", err);
    }

    uploadBtn.textContent = originalLabel;
    uploadBtn.disabled    = false;
    photoInput.value      = "";
  });

  removeBtn.addEventListener("click", () => {
    photoHidden.value = "";
    previewImg.src    = "";
    previewImg.classList.add("ph-hidden");
    placeholder.classList.remove("ph-hidden");
    removeBtn.classList.add("ph-hidden");
  });
})();
</script>

<%- include("partials/footer") %>