<%- include("partials/header") %>

<section class="builder-section">
  <div class="builder-header-row">
    <div>
      <h1>Resume Builder</h1>
      <p class="section-subtitle">
        Using template: <strong><%= template %></strong>
        &nbsp;·&nbsp;
        <a href="/resume-templates">Change template</a>
      </p>
    </div>
    <div class="builder-hint-pill">
      Step <span id="rbStepCounter">1</span> of 4
    </div>
  </div>

  <div class="builder-main">
    <div class="builder-left">
      <form
        id="resumeBuilderForm"
        action="/resume-builder/preview"
        method="POST"
        novalidate
      >
        <input type="hidden" name="template" value="<%= template %>">
        <input
          type="hidden"
          name="resumeId"
          id="resumeId"
          value="<%= typeof resumeId !== 'undefined' && resumeId ? resumeId : '' %>"
        >

        <!-- STEP 1 -->
        <div class="rb-step active" data-step="1">
          <h2 class="rb-step-title">Your Details</h2>
          <div class="rb-grid-2">
            <div class="rb-field">
              <label>Full Name<span class="req">*</span></label>
              <input type="text" name="fullName" required
                value="<%= (draft && draft.fullName) || (profile && profile.full_name) || '' %>">
            </div>

            <div class="rb-field">
              <label>Job Title</label>
              <input type="text" name="roleTitle"
                value="<%= (draft && draft.roleTitle) || (profile && profile.role_title) || '' %>">
            </div>

            <div class="rb-field">
              <label>Email<span class="req">*</span></label>
              <input type="email" name="email" required
                value="<%= (draft && draft.email) || (profile && profile.email) || (user && user.email) || '' %>">
            </div>

            <div class="rb-field">
              <label>Phone<span class="req">*</span></label>
              <input type="text" name="phone" required
                value="<%= (draft && draft.phone) || (profile && profile.phone) || '' %>">
            </div>

            <div class="rb-field">
              <label>Location</label>
              <input type="text" name="location"
                value="<%= (draft && draft.location) || (profile && profile.location) || '' %>">
            </div>

            <div class="rb-field">
              <label>Profile Photo URL</label>
              <input type="text" name="profileImageUrl"
                value="<%= (draft && draft.profileImageUrl) || (profile && profile.profile_image_url) || '' %>">
            </div>
          </div>
        </div>

        <!-- STEP 2 -->
        <div class="rb-step" data-step="2">
          <h2 class="rb-step-title">Professional Summary</h2>
          <textarea name="summary" rows="6"><%= (draft && draft.summary) || (profile && profile.summary) || '' %></textarea>
        </div>

        <!-- STEP 3 -->
        <div class="rb-step" data-step="3">
          <h2 class="rb-step-title">Experience</h2>
          <textarea name="experience" rows="8"><%= (draft && draft.experience) || (profile && profile.experience) || '' %></textarea>
        </div>

        <!-- STEP 4 -->
        <div class="rb-step" data-step="4">
          <h2 class="rb-step-title">Education, Languages & Skills</h2>
          <textarea name="education" rows="4"><%= (draft && draft.education) || '' %></textarea>
          <textarea name="languages" rows="3"><%= (draft && draft.languages) || '' %></textarea>
          <textarea name="skills" rows="4"><%= (draft && draft.skills) || '' %></textarea>
        </div>

        <!-- NAV -->
        <div class="rb-nav">
          <button type="button" id="rbBackBtn">Back</button>
          <button type="button" id="rbSaveBtn">Save Draft</button>
          <button type="button" id="rbNextBtn">Next</button>
          <button type="submit" id="rbSubmitBtn" style="display:none;">
            Preview Resume
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
(function () {
  const steps = document.querySelectorAll(".rb-step");
  const backBtn = document.getElementById("rbBackBtn");
  const nextBtn = document.getElementById("rbNextBtn");
  const submitBtn = document.getElementById("rbSubmitBtn");
  const form = document.getElementById("resumeBuilderForm");

  let current = 0;

  function updateUI() {
    steps.forEach((s, i) => s.style.display = i === current ? "block" : "none");
    nextBtn.style.display = current === steps.length - 1 ? "none" : "inline-block";
    submitBtn.style.display = current === steps.length - 1 ? "inline-block" : "none";
    backBtn.disabled = current === 0;
  }

  backBtn.onclick = () => {
    if (current > 0) current--;
    updateUI();
  };

  nextBtn.onclick = () => {
    if (current < steps.length - 1) current++;
    updateUI();
  };

  // ✅ REQUIRED FIX — FORCE SUBMIT
  submitBtn.addEventListener("click", () => {
    console.log("Preview Resume → submitting form");
    form.submit();
  });

  updateUI();
})();
</script>

<%- include("partials/footer") %>
