<%- include("partials/header") %>

<%
  // Normalize template name
  const tpl = template || "modern-1";

  // Allowed template IDs for partial loading
  const validTemplates = [
    "modern-1", "bold-sidebar", "minimal-1", "creative-gradient",
    "corporate-clean", "elegant-serif", "tech-focused", "classic-border"
  ];
  const safeTpl = validTemplates.includes(tpl) ? tpl : "modern-1";

  // Parse experience into [{title, company, dates, description}] objects.
  // Accepts either:
  //   • Array of objects (from AI Interview / JSONB storage)
  //   • Plain text string (legacy textarea format)
  function parseExperience(input) {
    // --- Array format (from AI Interview) ---
    if (Array.isArray(input)) {
      return input
        .filter(item => item && typeof item === "object")
        .map(item => ({
          title: item.title || "",
          company: item.company || "",
          dates: item.dates || "",
          description: (item.description || "").trim().replace(/\n{2,}/g, "\n")
        }));
    }

    // --- String format (legacy) ---
    if (!input || typeof input !== "string") return [];

    const lines = input
      .split(/\r?\n+/)
      .map(l => l.trim())
      .filter(l => l.length > 0);

    const jobs = [];
    let currentHeading = null;
    let currentDesc = [];

    for (const line of lines) {
      if (/^-/.test(line)) {
        if (currentHeading) {
          jobs.push({ heading: currentHeading, description: currentDesc.join(" ") });
        }
        currentHeading = line.replace(/^-\s*/, "");
        currentDesc = [];
      } else {
        currentDesc.push(line);
      }
    }

    if (currentHeading) {
      jobs.push({ heading: currentHeading, description: currentDesc.join(" ") });
    }

    return jobs.map(job => {
      // "Title [Company] (dates)" OR "Title (dates)"
      const mFull = job.heading.match(/^(.*?)\s*\[([^\]]+)\]\s*(\(.*\))\s*$/);
      const mDates = job.heading.match(/^(.*?)(\(\s*\d{4}.*\))\s*$/);
      if (mFull) {
        return { title: mFull[1].trim(), company: mFull[2].trim(), dates: mFull[3].trim(), description: job.description };
      }
      if (mDates) {
        return { title: mDates[1].trim(), company: "", dates: mDates[2].trim(), description: job.description };
      }
      return { title: job.heading, company: "", dates: "", description: job.description };
    });
  }

  // Simple bullets for skills: 1 line = 1 pill
  function renderBullets(text) {
    if (!text || typeof text !== "string") return [];
    return text
      .split(/\r?\n+/)
      .map(line => line.replace(/^\s*[-*•]\s*/, ""))
      .map(line => line.trim())
      .filter(line => line.length > 0);
  }

  let _expInput = data.experience || "";
  if (data.experienceJson) {
    try { _expInput = JSON.parse(data.experienceJson); } catch (_) {}
  }
  const experienceItems = parseExperience(_expInput);
  const skillsLines = renderBullets(data.skills || "");
%>

<style>
  /* ==== Preview / A4 wrapper ==== */
  .preview-section {
    padding: 1.5rem 1rem 2.5rem;
  }

  .preview-section > h1 {
    margin-bottom: 0.25rem;
  }

  .preview-section > p {
    margin-top: 0.2rem;
    margin-bottom: 0.75rem;
  }

  /* Scope UI styles to preview-section ONLY — not into the resume */
  .preview-section > button,
  .preview-section > .btn-primary,
  #download-image-btn {
    background: #111827;
    color: #fff;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
  }

  .preview-section > button:hover,
  .preview-section > .btn-primary:hover,
  #download-image-btn:hover {
    background: #facc15;
    color: #111827;
  }

  .preview-section > p > a,
  .preview-section > p a {
    color: #2563eb;
  }

  /* ===== OUTER WRAPPER: clips horizontal overflow, sized by JS ===== */
  .preview-wrapper {
    width: 100%;
    max-width: 820px;
    margin: 1rem auto;
    /*
     * overflow-x: clip  — prevents the 794px scale-container from creating a
     *   horizontal scrollbar on narrow screens. Unlike overflow:hidden, `clip`
     *   does NOT create a scroll container, so overflow-y can remain visible.
     * overflow-y: visible — content taller than the JS-set height can flow
     *   naturally; the page itself scrolls, not the wrapper.
     */
    overflow-x: clip;
    overflow-y: visible;
    position: relative;        /* stacking context for z-index */
  }

  /* ===== SCALE CONTAINER: holds the A4 and gets transform applied ===== */
  .preview-scale-container {
    width: 794px;              /* always A4 width */
    transform-origin: top left; /* set in CSS so JS never races to set it.
                                   Desktop: translateX centers it (origin irrelevant for translate).
                                   Mobile:  scale() anchors top-left — no rightward shift. */
  }

  /* ===== A4 CARD: captured as JPG, natural height for multi-page content ===== */
  .resume-a4 {
    width: 794px;
    min-height: 1123px;        /* A4 page height — content grows beyond this */
    height: auto;              /* MUST be auto so tall resumes expand naturally */
    background: #ffffff;
    box-shadow: 0 18px 40px rgba(15,23,42,0.18);
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    overflow: hidden;          /* clip sidebar bg colours to border-radius */
    position: relative;
    box-sizing: border-box;
  }

  /*
   * ===== .preview-wrapper .resume-page — minimal safety guard =====
   * The real neutralisation of style.css legacy rules (display:flex,
   * overflow:hidden, background:#f3f4f6, margin, max-width, box-shadow,
   * border-radius) is now done in templates.css base .resume-page {} at 0,1,0
   * via cascade order (templates.css loads after style.css).
   *
   * Template-specific display/background rules at 0,2,0 in templates.css
   * are NOT overridden here, so two-column templates (modern-1, bold-sidebar)
   * get their display:flex back and tech-focused gets its dark background back.
   *
   * This rule (0,2,0) only guards the three properties most critical to
   * the preview layout being correct.
   */
  .preview-wrapper .resume-page {
    margin: 0 !important;         /* style.css: margin:1.5rem auto — must never apply here */
    max-width: none !important;   /* style.css: max-width:900px — A4 is fixed at 794px */
    overflow: visible !important; /* must never clip multi-page vertical content */
  }

  /* ===== PRINT ===== */
  @media print {
    @page {
      size: A4;
      margin: 0;
    }

    body {
      margin: 0;
      background: #ffffff;
    }

    .preview-section > h1,
    .preview-section > p,
    #download-image-btn,
    #print-btn {
      display: none !important;
    }

    .preview-wrapper {
      overflow: visible;
      max-width: none;
      height: auto !important;   /* override JS-set pixel height */
    }

    .preview-scale-container {
      transform: none !important;  /* remove translateX / scale for print */
      margin: 0 auto;
    }

    .resume-a4 {
      width: 210mm;
      border: none;
      box-shadow: none;
      border-radius: 0;
      overflow: visible;         /* let content flow across print pages */
      min-height: auto;
      height: auto;
      margin: 0 auto;
    }

    /* ── Keep A4 page structure intact ── */
    .resume-page {
      overflow: visible !important;
      height: auto !important;
      min-height: auto !important;
    }

    /* ── Prevent experience entries from splitting across print pages ── */
    .experience-list li,
    .es-exp-item,
    .tf-exp-item,
    .cb-exp-item {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* ── Keep section headings with their first line of content ── */
    .modern-section-block h3,
    .bs-content-section h3,
    .min-section h3,
    .cg-section h3,
    .corp-section h3,
    .es-section h3,
    .tf-section h3,
    .cb-section h3 {
      page-break-after: avoid;
      break-after: avoid;
    }

    /* ── Avoid splitting whole short sections ── */
    .modern-section-block,
    .bs-content-section,
    .min-section,
    .cg-section,
    .corp-section,
    .es-section,
    .tf-section,
    .cb-section {
      page-break-inside: avoid;
      break-inside: avoid;
    }
  }

  .resume-watermark {
    position: absolute;
    inset: 0;
    z-index: 999;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3.2rem;
    font-weight: 700;
    color: rgba(17, 24, 39, 0.08);
    letter-spacing: 0.25em;
    text-transform: uppercase;
    transform: rotate(-30deg);
    user-select: none;
  }
</style>

<section class="preview-section">
  <h1>Resume Preview</h1>
  <p>
    Review your resume below. You can download it as JPG (A4).
    <br />
    Template: <strong><%= tpl %></strong>
    &nbsp;&middot;&nbsp; <a href="/resume-templates">Change template</a>
  </p>

  <!-- OUTER: clips overflow, prevents horizontal scroll -->
  <div class="preview-wrapper">
    <!-- SCALE CONTAINER: JS applies transform: scale() here on mobile -->
    <div class="preview-scale-container" id="scaleContainer">
      <!-- A4 container we capture for JPG / print -->
      <div id="resumeA4" class="resume-a4">
        <!-- WATERMARK (VISIBLE UNTIL PAYMENT) -->
        <div class="resume-watermark">
          SmrAI-Studio &bull; Preview &bull; Not Paid
        </div>

        <div class="resume-page <%= safeTpl %>">
          <%- include('templates/' + safeTpl, { data, experienceItems, skillsLines }) %>
        </div>
      </div>
    </div>
  </div>

  <button id="download-image-btn" style="margin-top:1rem;">
    PAY ₹49 &amp; DOWNLOAD AS JPG (A4)
  </button>

  <p style="margin-top:1rem;">
    <a href="/resume-builder">Edit details</a>
  </p>
</section>

<!-- ===== DYNAMIC MOBILE SCALING SCRIPT ===== -->
<script>
  (function () {
    var A4_WIDTH = 794;

    function scalePreview() {
      var wrapper   = document.querySelector(".preview-wrapper");
      var container = document.getElementById("scaleContainer");
      var a4        = document.getElementById("resumeA4");
      if (!wrapper || !container || !a4) return;

      /*
       * getBoundingClientRect() reads the ACTUAL rendered width of the wrapper.
       * It is more reliable than clientWidth on mobile browsers where an
       * overflowing child can inflate the parent's reported clientWidth.
       * Clamp to window.innerWidth as a final safety net — the wrapper
       * can never legitimately be wider than the viewport.
       */
      var availableWidth = wrapper.getBoundingClientRect().width;
      if (availableWidth > window.innerWidth) {
        availableWidth = window.innerWidth;
      }
      if (availableWidth <= 0) return; /* layout not ready yet */

      /*
       * Measure the A4's natural (un-transformed) height.
       * If images haven't loaded yet this may be an underestimate — the
       * "load" event re-runs scalePreview() once all resources are ready.
       */
      var naturalHeight = a4.offsetHeight || 1123;

      if (availableWidth >= A4_WIDTH) {
        /*
         * DESKTOP — center the 794px container inside the wrapper via
         * translateX instead of margin:auto.  translateX is explicit and
         * cannot be confused by the browser's block-layout auto-margin
         * algorithm when the child is wider than the parent.
         * transform-origin is already "top left" (set in CSS), so the
         * translate is always relative to the element's own top-left corner.
         */
        var offset = Math.round((availableWidth - A4_WIDTH) / 2);
        container.style.transform      = "translateX(" + offset + "px)";
        container.style.transformOrigin = "top left";
        container.style.margin         = "0";
        wrapper.style.height           = naturalHeight + "px";
      } else {
        /*
         * MOBILE — scale the A4 down so its visual width exactly fills the
         * available wrapper width.  transform-origin "top left" anchors the
         * scale to the wrapper's top-left corner, so the left edge of the
         * resume stays flush with the left edge of the wrapper — no
         * rightward shift, no sidebar clipping.
         *
         * The wrapper's explicit height is set to the visually-scaled height
         * so no empty space appears below the preview.
         */
        var scale = availableWidth / A4_WIDTH;
        container.style.transform       = "scale(" + scale + ")";
        container.style.transformOrigin = "top left";
        container.style.margin          = "0";
        wrapper.style.height            = Math.ceil(naturalHeight * scale) + "px";
      }
    }

    /*
     * Defer the first run by one animation frame so the browser has
     * finished painting the initial layout (getBoundingClientRect will
     * return the true rendered width, not 0 or a stale value).
     */
    function init() {
      requestAnimationFrame(function () {
        scalePreview();
      });
      window.addEventListener("resize", scalePreview);
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }

    /* Re-run after all resources (images, fonts) finish loading — the
       A4 height may increase once profile photos are rendered. */
    window.addEventListener("load", function () {
      requestAnimationFrame(scalePreview);
    });
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  (function () {
    const resumeNode = document.getElementById("resumeA4");
    const downloadBtn = document.getElementById("download-image-btn");
    if (!resumeNode || !downloadBtn) return;

    const resumeId = "<%= data.resumeId || '' %>";
    const templateName = "<%= safeTpl %>";

    // ---- JPG generation (multi-page A4) ----
    async function generateJpg() {
      downloadBtn.disabled = true;
      const originalText = downloadBtn.textContent;
      downloadBtn.textContent = "Preparing A4 JPG...";

      try {
        const A4_WIDTH_PX = 2480;
        const A4_HEIGHT_PX = 3508;

        // Temporarily remove CSS transform so html2canvas captures full size
        const scaleContainer = document.getElementById("scaleContainer");
        const prevTransform = scaleContainer ? scaleContainer.style.transform : "";
        const wrapperEl = document.querySelector(".preview-wrapper");
        const prevWrapperH = wrapperEl ? wrapperEl.style.height : "";

        if (scaleContainer) scaleContainer.style.transform = "none";
        if (wrapperEl) wrapperEl.style.height = "auto";

        const baseWidth = resumeNode.offsetWidth;
        const scale = A4_WIDTH_PX / baseWidth;

        // Capture the full content at A4-width resolution
        const fullCanvas = await html2canvas(resumeNode, {
          scale: scale,
          backgroundColor: "#ffffff",
          scrollX: 0,
          scrollY: -window.scrollY,
          windowWidth: resumeNode.scrollWidth,
          windowHeight: resumeNode.scrollHeight,
        });

        // Restore transforms
        if (scaleContainer) scaleContainer.style.transform = prevTransform;
        if (wrapperEl) wrapperEl.style.height = prevWrapperH;

        const fullHeight = fullCanvas.height;
        const totalPages = Math.ceil(fullHeight / A4_HEIGHT_PX);

        for (let i = 0; i < totalPages; i++) {
          const pageCanvas = document.createElement("canvas");
          pageCanvas.width = A4_WIDTH_PX;
          // Last page may be shorter
          const sliceH = Math.min(A4_HEIGHT_PX, fullHeight - i * A4_HEIGHT_PX);
          pageCanvas.height = sliceH;

          const ctx = pageCanvas.getContext("2d");
          // Fill white background
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, A4_WIDTH_PX, sliceH);
          // Draw the slice from the full canvas
          ctx.drawImage(
            fullCanvas,
            0, i * A4_HEIGHT_PX,          // source x, y
            A4_WIDTH_PX, sliceH,           // source w, h
            0, 0,                          // dest x, y
            A4_WIDTH_PX, sliceH            // dest w, h
          );

          const dataUrl = pageCanvas.toDataURL("image/jpeg", 0.95);
          const link = document.createElement("a");
          const suffix = totalPages > 1 ? "-page" + (i + 1) : "";
          link.download = "SmrAI-Studio-Resume" + suffix + ".jpg";
          link.href = dataUrl;
          link.click();

          // Small delay between downloads so browser doesn't block them
          if (totalPages > 1 && i < totalPages - 1) {
            await new Promise(function (r) { setTimeout(r, 400); });
          }
        }
      } catch (err) {
        console.error(err);
        alert("Failed to generate JPG. Check console for details.");
      } finally {
        downloadBtn.disabled = false;
        downloadBtn.textContent = originalText;
      }
    }

    // ---- Razorpay helpers ----
    async function createOrder() {
      const res = await fetch("/api/razorpay/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      const json = await res.json();
      if (!json.success) throw new Error("Order creation failed");
      return json;
    }

    async function startPayment(action) {
      try {
        const orderData = await createOrder();

        const options = {
          key: orderData.key,
          amount: orderData.amount,
          currency: orderData.currency,
          name: "SmrAI-Studio",
          description: templateName + " Resume " + (action === "print" ? "Print" : "Download"),
          order_id: orderData.orderId,
          handler: async function (response) {
            try {
              const verifyRes = await fetch("/api/razorpay/verify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_signature: response.razorpay_signature,
                  purpose: action === "print" ? "print" : "download",
                  resumeId: resumeId || null,
                }),
              });

              const verifyData = await verifyRes.json();

              if (!verifyData.success) {
                alert("Payment verification failed. Please contact support.");
                return;
              }

              // Remove watermark after payment
              const wm = document.querySelector(".resume-watermark");
              if (wm) wm.remove();

              if (action === "download") {
                await generateJpg();
              } else if (action === "print") {
                window.print();
              }
            } catch (err) {
              console.error("Verify/payment error:", err);
              alert("Something went wrong while verifying payment.");
            }
          },
          prefill: {
            name: "<%= data.fullName || '' %>",
            email: "<%= data.email || '' %>",
            contact: "<%= data.phone || '' %>"
          },
          theme: {
            color: "#27355a"
          }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error(err);
        alert("Unable to start payment. Please try again.");
      }
    }

    // ---- All templates require payment ----
    downloadBtn.addEventListener("click", function () {
      startPayment("download");
    });
  })();
</script>

<%- include("partials/footer") %>
