<%- include("../partials/header") %>
<link rel="stylesheet" href="/css/admin.css">
<script>
  document.body.classList.add("adm-page");
</script>

<!-- Hamburger drawer overlay (mobile only) -->
<div class="adm-drawer-overlay" id="admDrawerOverlay"></div>

<div class="adm-shell">

  <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="adm-sidebar">
    <div class="adm-sidebar-logo">
      <img src="/images/logo.png" alt="SmrAI-Studio" style="height:32px; width:auto;">
      <span>Admin</span>
    </div>
    <nav class="adm-sidebar-nav">
      <a href="#overview"  class="adm-nav-link adm-nav-active" data-section="overview">
        <i class="fas fa-chart-line"></i> Overview
      </a>
      <a href="#users"     class="adm-nav-link" data-section="users">
        <i class="fas fa-users"></i> Users
      </a>
      <a href="#activity"  class="adm-nav-link" data-section="activity">
        <i class="fas fa-stream"></i> Activity
      </a>
      <a href="#requests"  class="adm-nav-link" data-section="requests">
        <i class="fas fa-inbox"></i> Requests
        <span class="adm-nav-badge" id="navRequestsBadge" hidden></span>
      </a>
      <a href="#pricing"   class="adm-nav-link" data-section="pricing">
        <i class="fas fa-tags"></i> Pricing
      </a>
      <a href="/dashboard" class="adm-nav-link adm-nav-back">
        <i class="fas fa-arrow-left"></i> Back to App
      </a>
    </nav>
  </aside>

  <!-- â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="adm-main">

    <!-- Topbar -->
    <header class="adm-topbar">
      <div class="adm-topbar-left">
        <button class="adm-mobile-menu-btn" id="admMobileMenu" type="button">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="adm-topbar-title">Admin Dashboard</h1>
      </div>
      <div class="adm-topbar-right">
        <span class="adm-topbar-user">
          <i class="fas fa-shield-alt"></i>
          <%= currentUser.name %>
        </span>
      </div>
    </header>

    <!-- â”€â”€ Section: Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="overview" class="adm-section-page">

      <!-- Stat cards -->
      <div class="adm-stat-grid">
        <div class="adm-stat-card" style="--adm-card-delay:0.05s" data-detail="users">
          <div class="adm-stat-icon adm-icon-blue"><i class="fas fa-users"></i></div>
          <div class="adm-stat-text">
            <div class="adm-stat-num" data-target="<%= stats.totalUsers %>">0</div>
            <div class="adm-stat-label">Total Users</div>
          </div>
        </div>
        <div class="adm-stat-card" style="--adm-card-delay:0.10s" data-detail="activity">
          <div class="adm-stat-icon adm-icon-green"><i class="fas fa-bolt"></i></div>
          <div class="adm-stat-text">
            <div class="adm-stat-num" data-target="<%= stats.activeToday %>">0</div>
            <div class="adm-stat-label">Active Today</div>
          </div>
        </div>
        <div class="adm-stat-card" style="--adm-card-delay:0.15s" data-detail="resumes">
          <div class="adm-stat-icon adm-icon-purple"><i class="fas fa-file-alt"></i></div>
          <div class="adm-stat-text">
            <div class="adm-stat-num" data-target="<%= stats.totalResumes %>">0</div>
            <div class="adm-stat-label">Resumes</div>
          </div>
        </div>
        <div class="adm-stat-card" style="--adm-card-delay:0.20s" data-detail="downloads">
          <div class="adm-stat-icon adm-icon-orange"><i class="fas fa-download"></i></div>
          <div class="adm-stat-text">
            <div class="adm-stat-num" data-target="<%= stats.totalDownloads %>">0</div>
            <div class="adm-stat-label">Downloads</div>
          </div>
        </div>
        <div class="adm-stat-card" style="--adm-card-delay:0.25s" data-detail="revenue">
          <div class="adm-stat-icon adm-icon-emerald"><i class="fas fa-rupee-sign"></i></div>
          <div class="adm-stat-text">
            <div class="adm-stat-num" data-target="<%= stats.totalRevenue %>" data-prefix="â‚¹">â‚¹0</div>
            <div class="adm-stat-label">Revenue</div>
          </div>
        </div>
        <div class="adm-stat-card" style="--adm-card-delay:0.30s" data-detail="ai">
          <div class="adm-stat-icon adm-icon-pink"><i class="fas fa-robot"></i></div>
          <div class="adm-stat-text">
            <div class="adm-stat-num" data-target="<%= stats.aiRequests %>">0</div>
            <div class="adm-stat-label">AI Requests</div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="adm-charts-row">
        <div class="adm-chart-box">
          <h3 class="adm-chart-title">Page Visit Heatmap</h3>
          <canvas id="chartRoutes" height="140"></canvas>
        </div>
        <div class="adm-chart-box">
          <h3 class="adm-chart-title">Downloads by Template</h3>
          <canvas id="chartTemplates" height="140"></canvas>
        </div>
      </div>

    </div><!-- /overview -->

    <!-- â”€â”€ Section: Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="users" class="adm-section-page" hidden>

      <div class="adm-section">
        <div class="adm-section-header">
          <h2>User Management</h2>
          <input class="adm-search" id="userSearch" type="search" placeholder="Search name or emailâ€¦">
        </div>
        <div class="adm-table-wrap">
          <table class="adm-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Role</th>
                <th>Resumes</th>
                <th>Downloads</th>
                <th>Revenue</th>
                <th>Last Active</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr><td colspan="7" class="adm-loading">Loading usersâ€¦</td></tr>
            </tbody>
          </table>
        </div>
        <div class="adm-pagination" id="userPagination"></div>
      </div>

    </div><!-- /users -->

    <!-- â”€â”€ Section: Activity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="activity" class="adm-section-page" hidden>

      <div class="adm-section">
        <div class="adm-section-header">
          <h2>Live Activity Feed</h2>
          <div style="display:flex;align-items:center;gap:0.6rem;margin-left:auto">
            <span class="adm-badge adm-badge-green">
              <span class="adm-pulse"></span> Live
            </span>
            <div class="adm-delete-wrap">
              <select id="actDeletePeriod" class="adm-delete-select">
                <option value="">ðŸ—‘ Deleteâ€¦</option>
                <option value="recent">Last 1 hour</option>
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="all">All activity</option>
              </select>
            </div>
          </div>
        </div>
        <div id="activityFeed">
          <div class="adm-loading">Loading activityâ€¦</div>
        </div>
      </div>

    </div><!-- /activity -->

    <!-- â”€â”€ Section: Requests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="requests" class="adm-section-page" hidden>

      <div class="adm-section">
        <div class="adm-section-header">
          <h2>Service Requests</h2>
          <div style="display:flex;align-items:center;gap:0.6rem">
            <select id="srFilterStatus" class="adm-sr-filter">
              <option value="">All statuses</option>
              <option value="new">New</option>
              <option value="in_progress">In Progress</option>
              <option value="done">Done</option>
              <option value="closed">Closed</option>
            </select>
          </div>
        </div>

        <div class="adm-table-wrap">
          <table class="adm-table">
            <thead>
              <tr>
                <th>From</th>
                <th>Service</th>
                <th>Details</th>
                <th>Status</th>
                <th>Date</th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="srBody">
              <tr><td colspan="7" class="adm-loading">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
        <div class="adm-pagination" id="srPagination"></div>
      </div>

    </div><!-- /requests -->

    <!-- â”€â”€ Section: Pricing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="pricing" class="adm-section-page" hidden>

      <div class="adm-section">
        <div class="adm-section-header">
          <h2>Resume Pricing</h2>
          <p class="adm-section-desc">Set the download price for each resume category. Changes apply immediately to all new purchases.</p>
        </div>

        <div class="adm-price-grid">

          <!-- Fresher -->
          <div class="adm-price-card">
            <div class="adm-price-card-icon adm-icon-green"><i class="fas fa-seedling"></i></div>
            <div class="adm-price-card-info">
              <h3>Fresher</h3>
              <p>Simple & Minimal templates for entry-level profiles</p>
            </div>
            <div class="adm-price-card-input-wrap">
              <span class="adm-price-currency">â‚¹</span>
              <input type="number" class="adm-price-input" id="price_fresher" min="0" step="1" placeholder="100" />
            </div>
            <button class="adm-price-save-btn" data-key="price_fresher">
              <i class="fas fa-check"></i> Save
            </button>
            <span class="adm-price-status" id="status_price_fresher" hidden></span>
          </div>

          <!-- Experienced -->
          <div class="adm-price-card">
            <div class="adm-price-card-icon adm-icon-blue"><i class="fas fa-briefcase"></i></div>
            <div class="adm-price-card-info">
              <h3>Experienced</h3>
              <p>Modern, Bold Sidebar, Creative, Corporate templates</p>
            </div>
            <div class="adm-price-card-input-wrap">
              <span class="adm-price-currency">â‚¹</span>
              <input type="number" class="adm-price-input" id="price_experienced" min="0" step="1" placeholder="100" />
            </div>
            <button class="adm-price-save-btn" data-key="price_experienced">
              <i class="fas fa-check"></i> Save
            </button>
            <span class="adm-price-status" id="status_price_experienced" hidden></span>
          </div>

          <!-- Developer -->
          <div class="adm-price-card">
            <div class="adm-price-card-icon adm-icon-purple"><i class="fas fa-code"></i></div>
            <div class="adm-price-card-info">
              <h3>Developer</h3>
              <p>Tech-Focused template for software engineers</p>
            </div>
            <div class="adm-price-card-input-wrap">
              <span class="adm-price-currency">â‚¹</span>
              <input type="number" class="adm-price-input" id="price_developer" min="0" step="1" placeholder="500" />
            </div>
            <button class="adm-price-save-btn" data-key="price_developer">
              <i class="fas fa-check"></i> Save
            </button>
            <span class="adm-price-status" id="status_price_developer" hidden></span>
          </div>

          <!-- ATS Friendly -->
          <div class="adm-price-card">
            <div class="adm-price-card-icon adm-icon-green"><i class="fas fa-robot"></i></div>
            <div class="adm-price-card-info">
              <h3>ATS Friendly CV</h3>
              <p>ATS-optimised developer template with semantic headings and clickable contact links</p>
            </div>
            <div class="adm-price-card-input-wrap">
              <span class="adm-price-currency">â‚¹</span>
              <input type="number" class="adm-price-input" id="price_ats-friendly" min="0" step="1" placeholder="500" />
            </div>
            <button class="adm-price-save-btn" data-key="price_ats-friendly">
              <i class="fas fa-check"></i> Save
            </button>
            <span class="adm-price-status" id="status_price_ats-friendly" hidden></span>
          </div>

        </div><!-- /adm-price-grid -->

      </div>

    </div><!-- /pricing -->

  </div><!-- /adm-main -->
</div><!-- /adm-shell -->

<!-- â”€â”€ Service request detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="srDetailModal" class="adm-modal-backdrop" hidden>
  <div class="adm-modal adm-stat-modal">
    <button class="adm-modal-close" id="srDetailClose" type="button">&times;</button>
    <h3 class="adm-stat-modal-title" id="srDetailTitle"></h3>
    <div id="srDetailBody" class="adm-stat-modal-body"></div>
  </div>
</div>

<!-- â”€â”€ Delete service request confirmation modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="srDeleteModal" class="adm-modal-backdrop" hidden>
  <div class="adm-modal adm-confirm-modal">
    <div class="adm-confirm-icon adm-confirm-icon-danger"><i class="fas fa-inbox"></i></div>
    <h3 class="adm-confirm-title">Delete Request</h3>
    <p class="adm-confirm-msg" id="srDeleteMsg"></p>
    <div class="adm-confirm-actions">
      <button class="adm-confirm-cancel" id="srDeleteCancel" type="button">Cancel</button>
      <button class="adm-confirm-delete" id="srDeleteConfirm" type="button">
        <i class="fas fa-trash-alt"></i> Yes, Delete
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ Delete activity confirmation modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="actDeleteModal" class="adm-modal-backdrop" hidden>
  <div class="adm-modal adm-confirm-modal">
    <div class="adm-confirm-icon"><i class="fas fa-trash-alt"></i></div>
    <h3 class="adm-confirm-title">Delete Activity</h3>
    <p class="adm-confirm-msg" id="actDeleteMsg"></p>
    <div class="adm-confirm-actions">
      <button class="adm-confirm-cancel" id="actDeleteCancel" type="button">Cancel</button>
      <button class="adm-confirm-delete" id="actDeleteConfirm" type="button">
        <i class="fas fa-trash-alt"></i> Yes, Delete
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ User delete confirmation modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="userDeleteModal" class="adm-modal-backdrop" hidden>
  <div class="adm-modal adm-confirm-modal">
    <div class="adm-confirm-icon adm-confirm-icon-danger"><i class="fas fa-user-times"></i></div>
    <h3 class="adm-confirm-title">Delete User</h3>
    <p class="adm-confirm-msg" id="userDeleteMsg"></p>
    <div class="adm-confirm-actions">
      <button class="adm-confirm-cancel" id="userDeleteCancel" type="button">Cancel</button>
      <button class="adm-confirm-delete" id="userDeleteConfirm" type="button">
        <i class="fas fa-user-times"></i> Yes, Delete
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ Guest visitors drill-down modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="guestActModal" class="adm-modal-backdrop" hidden>
  <div class="adm-modal adm-stat-modal">
    <button class="adm-modal-close" id="guestActModalClose" type="button" aria-label="Close">&times;</button>
    <h3 class="adm-stat-modal-title">
      <i class="fas fa-globe" style="color:#6366f1;margin-right:0.4rem"></i>
      Anonymous Visitors
    </h3>
    <div id="guestActModalBody" class="adm-stat-modal-body"></div>
  </div>
</div>

<!-- â”€â”€ User activity detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="userActModal" class="adm-modal-backdrop" hidden>
  <div class="adm-modal adm-stat-modal">
    <button class="adm-modal-close" id="userActModalClose" type="button" aria-label="Close">&times;</button>
    <h3 id="userActModalTitle" class="adm-stat-modal-title"></h3>
    <div id="userActModalBody" class="adm-stat-modal-body"></div>
  </div>
</div>

<!-- â”€â”€ Admin Chat modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="admChatModal" class="adm-chat-backdrop" hidden role="dialog" aria-modal="true">
  <div class="adm-chat-box">
    <div class="adm-chat-header">
      <div class="adm-chat-header-info">
        <div class="adm-chat-avatar"><i class="fas fa-user"></i></div>
        <div>
          <div class="adm-chat-title" id="admChatTitle">User Chat</div>
          <div class="adm-chat-sub" id="admChatSub"></div>
        </div>
      </div>
      <button class="adm-chat-close" id="admChatClose" type="button">&times;</button>
    </div>
    <div class="adm-chat-messages" id="admChatMessages">
      <div class="adm-chat-empty">Loading messagesâ€¦</div>
    </div>
    <form class="adm-chat-input-bar" id="admChatForm" autocomplete="off">
      <textarea class="adm-chat-input" id="admChatInput" rows="1" placeholder="Reply to userâ€¦" maxlength="2000"></textarea>
      <button class="adm-chat-send" type="submit" aria-label="Send"><i class="fas fa-paper-plane"></i></button>
    </form>
  </div>
</div>

<!-- â”€â”€ Stat detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="statModal" class="adm-modal-backdrop" hidden>
  <div class="adm-modal adm-stat-modal">
    <button class="adm-modal-close" id="statModalClose" type="button" aria-label="Close">&times;</button>
    <h3 id="statModalTitle" class="adm-stat-modal-title"></h3>
    <div id="statModalBody" class="adm-stat-modal-body"></div>
  </div>
</div>

<!-- â”€â”€ User detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="userModal" class="adm-modal-backdrop" hidden>
  <div class="adm-modal" role="dialog" aria-modal="true">
    <button class="adm-modal-close" id="modalClose" type="button" aria-label="Close">&times;</button>
    <div id="userModalBody"></div>
  </div>
</div>

<!-- Socket.io + Chart.js -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SmrAI-Studio Admin Dashboard JS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Section navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sections = document.querySelectorAll(".adm-section-page");
const navLinks  = document.querySelectorAll(".adm-nav-link[data-section]");
const admMain   = document.querySelector(".adm-main");

function showSection(id) {
  // Fade out current section
  sections.forEach(s => {
    if (!s.hidden) s.style.opacity = "0";
  });

  setTimeout(() => {
    sections.forEach(s => {
      s.hidden = s.id !== id;
      s.style.opacity = "";
    });
    navLinks.forEach(l => l.classList.toggle("adm-nav-active", l.dataset.section === id));

    // Scroll back to top of content area (desktop: adm-main, mobile: window)
    if (admMain && window.innerWidth > 768) {
      admMain.scrollTo({ top: 0, behavior: "smooth" });
    } else {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    if (id === "users"    && !usersLoaded)   { loadUsers(1); }
    if (id === "activity" && !activityLoaded){ loadActivity(); }
    if (id === "requests" && !srLoaded)      { loadServiceRequests(1); }
    if (id === "pricing"  && !pricingLoaded) { loadPricing(); }
  }, 120);
}

navLinks.forEach(l => l.addEventListener("click", e => {
  e.preventDefault();
  showSection(l.dataset.section);
}));


// â”€â”€ Animated counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animateCounter(el) {
  const target = parseInt(el.dataset.target) || 0;
  const prefix = el.dataset.prefix || "";
  const duration = 900;
  const start = performance.now();
  function step(now) {
    const progress = Math.min((now - start) / duration, 1);
    const ease = 1 - Math.pow(1 - progress, 3);
    el.textContent = prefix + Math.round(ease * target).toLocaleString("en-IN");
    if (progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

document.querySelectorAll(".adm-stat-num[data-target]").forEach(el => {
  const obs = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) { animateCounter(el); obs.disconnect(); }
  }, { threshold: 0.5 });
  obs.observe(el);
});

// â”€â”€ Chart.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHART_COLORS = [
  "#6366f1","#22c55e","#f59e0b","#ef4444",
  "#14b8a6","#ec4899","#8b5cf6","#3b82f6"
];

async function loadCharts() {
  try {
    const res  = await fetch("/admin/api/charts");
    const data = await res.json();
    if (!data.success) return;

    // Route hits
    const rCtx = document.getElementById("chartRoutes").getContext("2d");
    new Chart(rCtx, {
      type: "bar",
      data: {
        labels:   data.routeHits.map(r => r.route),
        datasets: [{
          label: "Visits",
          data:  data.routeHits.map(r => r.hits),
          backgroundColor: CHART_COLORS,
          borderRadius: 6,
        }],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales:  { y: { beginAtZero: true, ticks: { precision: 0 } } },
      },
    });

    // Template downloads
    const tCtx = document.getElementById("chartTemplates").getContext("2d");
    new Chart(tCtx, {
      type: "doughnut",
      data: {
        labels:   data.templateDownloads.map(t => t.template),
        datasets: [{
          data:            data.templateDownloads.map(t => t.downloads),
          backgroundColor: CHART_COLORS,
          borderWidth:     2,
        }],
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom", labels: { boxWidth: 12 } } },
      },
    });
  } catch (_) {}
}

loadCharts();

// â”€â”€ Hamburger drawer (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const menuBtn  = document.getElementById('admMobileMenu');
  const sidebar  = document.querySelector('.adm-sidebar');
  const overlay  = document.getElementById('admDrawerOverlay');
  const navLinks = document.querySelectorAll('.adm-nav-link[data-section]');

  function openDrawer() {
    sidebar.classList.add('adm-drawer-open');
    overlay.classList.add('adm-overlay-open');
    document.body.style.overflow = 'hidden';
    menuBtn.innerHTML = '<i class="fas fa-times"></i>';
  }

  function closeDrawer() {
    sidebar.classList.remove('adm-drawer-open');
    overlay.classList.remove('adm-overlay-open');
    document.body.style.overflow = '';
    menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
  }

  menuBtn.addEventListener('click', () => {
    sidebar.classList.contains('adm-drawer-open') ? closeDrawer() : openDrawer();
  });

  overlay.addEventListener('click', closeDrawer);

  // Close drawer when a nav item is tapped
  navLinks.forEach(l => l.addEventListener('click', () => {
    if (window.innerWidth <= 768) closeDrawer();
  }));
})();

// â”€â”€ Users table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let usersLoaded   = false;
let currentPage   = 1;
let currentQuery  = "";
let debounceTimer = null;

function fmtDate(iso) {
  if (!iso) return "â€”";
  return new Date(iso).toLocaleDateString("en-IN", { day: "2-digit", month: "short", year: "numeric" });
}

function avatarHtml(u) {
  if (u.profile_image_url) {
    return `<img src="${u.profile_image_url}" class="adm-avatar-sm" alt="">`;
  }
  const letter = (u.full_name || u.name || u.email || "?")[0].toUpperCase();
  return `<span class="adm-avatar-init">${letter}</span>`;
}

async function loadUsers(page, q) {
  usersLoaded  = true;
  currentPage  = page  ?? currentPage;
  currentQuery = q     ?? currentQuery;

  const params = new URLSearchParams({ page: currentPage, limit: 20 });
  if (currentQuery) params.set("q", currentQuery);

  try {
    const res  = await fetch("/admin/api/users?" + params);
    const data = await res.json();
    if (!data.success) return;

    const tbody = document.getElementById("usersBody");
    tbody.innerHTML = data.users.length ? "" : `<tr><td colspan="7" class="adm-loading">No users found.</td></tr>`;

    data.users.forEach(u => {
      const tr = document.createElement("tr");
      tr.dataset.uid = u.id;
      tr.innerHTML = `
        <td>
          <div class="adm-user-cell">
            ${avatarHtml(u)}
            <span>${u.full_name || u.name || "â€”"}</span>
          </div>
        </td>
        <td class="adm-muted">${u.email}</td>
        <td><span class="adm-badge ${u.role === "admin" ? "adm-badge-admin" : "adm-badge-user"}">${u.role}</span></td>
        <td>${u.resume_count}</td>
        <td>${u.download_count}</td>
        <td>â‚¹${Math.round(u.total_paid / 100)}</td>
        <td class="adm-muted">${fmtDate(u.last_active)}</td>
      `;
      tr.addEventListener("click", () => openUserModal(u.id));
      tbody.appendChild(tr);
    });

    renderPagination(data.total, data.limit);
  } catch (err) {
    console.error("loadUsers error:", err);
    document.getElementById("usersBody").innerHTML =
      `<tr><td colspan="7" class="adm-loading" style="color:#ef4444">Failed to load users. Check console.</td></tr>`;
  }
}

function renderPagination(total, limit) {
  const pages = Math.ceil(total / limit);
  const el    = document.getElementById("userPagination");
  el.innerHTML = "";
  if (pages <= 1) return;

  for (let p = 1; p <= pages; p++) {
    const btn = document.createElement("button");
    btn.textContent = p;
    btn.className   = "adm-page-btn" + (p === currentPage ? " adm-page-active" : "");
    btn.addEventListener("click", () => loadUsers(p));
    el.appendChild(btn);
  }
}

document.getElementById("userSearch").addEventListener("input", e => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => loadUsers(1, e.target.value.trim()), 350);
});

// â”€â”€ User modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openUserModal(uid) {
  const modal = document.getElementById("userModal");
  const body  = document.getElementById("userModalBody");
  body.innerHTML = `<div class="adm-loading" style="padding:2rem 0">Loadingâ€¦</div>`;
  modal.hidden = false;
  document.body.style.overflow = "hidden";

  try {
    const res  = await fetch(`/admin/api/user/${uid}`);
    const data = await res.json();
    if (!data.success) { body.innerHTML = "<p>Failed to load user.</p>"; return; }

    const u = data.user;
    body.innerHTML = `
      <div class="adm-modal-avatar-row">
        ${u.profile_image_url
          ? `<img src="${u.profile_image_url}" class="adm-modal-avatar" alt="">`
          : `<span class="adm-avatar-init adm-avatar-init-lg">${(u.full_name||u.name||u.email||"?")[0].toUpperCase()}</span>`
        }
        <div>
          <h3 class="adm-modal-name">${u.full_name || u.name || "â€”"}</h3>
          <p class="adm-modal-email">${u.email}</p>
          <div style="display:flex;align-items:center;gap:0.4rem;flex-wrap:wrap;margin-top:0.3rem">
            <span class="adm-badge ${u.role === "admin" ? "adm-badge-admin" : "adm-badge-user"}" id="modalRoleBadge">${u.role}</span>
            <span class="adm-badge ${u.is_active ? "adm-badge-active" : "adm-badge-inactive"}" id="modalActiveBadge">
              ${u.is_active ? "Active" : "Inactive"}
            </span>
          </div>
        </div>
      </div>

      <div class="adm-modal-grid">
        <div class="adm-modal-field"><span class="adm-modal-label">Phone</span><span>${u.phone || "â€”"}</span></div>
        <div class="adm-modal-field"><span class="adm-modal-label">Location</span><span>${u.location || "â€”"}</span></div>
        <div class="adm-modal-field"><span class="adm-modal-label">Member since</span><span>${fmtDate(u.created_at)}</span></div>
        <div class="adm-modal-field"><span class="adm-modal-label">Last active</span><span>${fmtDate(u.last_active)}</span></div>
      </div>

      <div class="adm-modal-stats">
        <div class="adm-modal-stat"><span class="adm-modal-stat-num">${u.resumes}</span><span class="adm-modal-stat-label">Resumes</span></div>
        <div class="adm-modal-stat"><span class="adm-modal-stat-num">${u.downloads}</span><span class="adm-modal-stat-label">Downloads</span></div>
        <div class="adm-modal-stat"><span class="adm-modal-stat-num">${u.ai_uses}</span><span class="adm-modal-stat-label">AI Uses</span></div>
        <div class="adm-modal-stat"><span class="adm-modal-stat-num">â‚¹${u.total_paid}</span><span class="adm-modal-stat-label">Revenue</span></div>
      </div>

      <div class="adm-modal-actions">
        <button class="adm-role-btn ${u.role === "admin" ? "adm-role-btn-demote" : "adm-role-btn-promote"}"
                id="roleToggleBtn"
                data-uid="${u.id}"
                data-current="${u.role}">
          ${u.role === "admin" ? "â¬‡ Demote to User" : "â¬† Promote to Admin"}
        </button>
        <button class="adm-toggle-active-btn ${u.is_active ? "adm-toggle-active-btn-deactivate" : "adm-toggle-active-btn-activate"}"
                id="toggleActiveBtn"
                data-uid="${u.id}"
                data-active="${u.is_active}">
          <i class="fas ${u.is_active ? "fa-ban" : "fa-check-circle"}"></i>
          ${u.is_active ? "Deactivate" : "Activate"}
        </button>
        <button class="adm-delete-user-btn" id="deleteUserBtn" data-uid="${u.id}" data-name="${(u.full_name||u.name||u.email||"User").replace(/"/g,"&quot;")}">
          <i class="fas fa-trash-alt"></i> Delete
        </button>
      </div>
    `;

    document.getElementById("roleToggleBtn").addEventListener("click", async function () {
      const newRole = this.dataset.current === "admin" ? "user" : "admin";
      this.disabled = true;
      try {
        const r = await fetch(`/admin/api/user/${this.dataset.uid}/role`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ role: newRole }),
        });
        const d = await r.json();
        if (d.success) {
          this.dataset.current = newRole;
          this.textContent = newRole === "admin" ? "â¬‡ Demote to User" : "â¬† Promote to Admin";
          this.className = "adm-role-btn " + (newRole === "admin" ? "adm-role-btn-demote" : "adm-role-btn-promote");
          document.getElementById("modalRoleBadge").textContent = newRole;
          document.getElementById("modalRoleBadge").className =
            "adm-badge " + (newRole === "admin" ? "adm-badge-admin" : "adm-badge-user");
          // Refresh the table row badge
          const row = document.querySelector(`tr[data-uid="${this.dataset.uid}"]`);
          if (row) {
            const badge = row.querySelector(".adm-badge");
            if (badge) { badge.textContent = newRole; badge.className = "adm-badge " + (newRole === "admin" ? "adm-badge-admin" : "adm-badge-user"); }
          }
        } else {
          alert(d.message || "Failed to update role.");
        }
      } catch (_) {
        alert("Network error.");
      } finally {
        this.disabled = false;
      }
    });

    // â”€â”€ Toggle active handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("toggleActiveBtn").addEventListener("click", async function () {
      const uid  = this.dataset.uid;
      const prev = this.dataset.active === "true";
      this.disabled = true;
      try {
        const r = await fetch(`/admin/api/user/${uid}/toggle-active`, { method: "PATCH" });
        const d = await r.json();
        if (d.success) {
          const nowActive = d.is_active;
          this.dataset.active = nowActive;
          this.innerHTML = `<i class="fas ${nowActive ? "fa-ban" : "fa-check-circle"}"></i> ${nowActive ? "Deactivate" : "Activate"}`;
          this.className = `adm-toggle-active-btn ${nowActive ? "adm-toggle-active-btn-deactivate" : "adm-toggle-active-btn-activate"}`;
          const badge = document.getElementById("modalActiveBadge");
          badge.textContent = nowActive ? "Active" : "Inactive";
          badge.className   = `adm-badge ${nowActive ? "adm-badge-active" : "adm-badge-inactive"}`;
        } else {
          alert(d.message || "Failed to update status.");
        }
      } catch (_) {
        alert("Network error.");
      } finally {
        this.disabled = false;
      }
    });

    // â”€â”€ Delete user handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("deleteUserBtn").addEventListener("click", function () {
      const uid  = this.dataset.uid;
      const name = this.dataset.name;
      document.getElementById("userDeleteMsg").innerHTML =
        `This will permanently delete <strong>${name}</strong> and all their data. This cannot be undone.`;
      document.getElementById("userDeleteModal").hidden = false;
      document.getElementById("userDeleteConfirm").dataset.uid = uid;
    });

  } catch (_) {
    body.innerHTML = "<p>Error loading user.</p>";
  }
}

function closeModal() {
  document.getElementById("userModal").hidden = true;
  document.body.style.overflow = "";
}

document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("userModal").addEventListener("click", e => {
  if (e.target === e.currentTarget) closeModal();
});
document.addEventListener("keydown", e => {
  if (e.key === "Escape") {
    closeModal();
    closeStatModal();
    document.getElementById("userDeleteModal").hidden = true;
    document.getElementById("guestActModal").hidden   = true;
    document.getElementById("srDetailModal").hidden   = true;
    document.getElementById("srDeleteModal").hidden   = true;
  }
});

// â”€â”€ User delete confirm / cancel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("userDeleteCancel").addEventListener("click", () => {
  document.getElementById("userDeleteModal").hidden = true;
});
document.getElementById("userDeleteModal").addEventListener("click", e => {
  if (e.target === e.currentTarget) e.currentTarget.hidden = true;
});

document.getElementById("userDeleteConfirm").addEventListener("click", async function () {
  const uid = this.dataset.uid;
  this.disabled = true;
  this.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Deletingâ€¦`;
  try {
    const res  = await fetch(`/admin/api/user/${uid}`, { method: "DELETE" });
    const data = await res.json();
    document.getElementById("userDeleteModal").hidden = true;
    if (data.success) {
      closeModal();
      // Remove the user row from the table if visible
      const row = document.querySelector(`tr[data-uid="${uid}"]`);
      if (row) row.remove();
    } else {
      alert(data.message || "Failed to delete user.");
    }
  } catch (_) {
    document.getElementById("userDeleteModal").hidden = true;
    alert("Network error.");
  } finally {
    this.disabled = false;
    this.innerHTML = `<i class="fas fa-user-times"></i> Yes, Delete`;
  }
});

// â”€â”€ Stat card detail modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STAT_TITLES = {
  resumes:   "All Resumes",
  downloads: "Recent Downloads",
  revenue:   "Payment History",
  ai:        "AI Usage Log",
};

function closeStatModal() {
  document.getElementById("statModal").hidden = true;
}

document.getElementById("statModalClose").addEventListener("click", closeStatModal);
document.getElementById("statModal").addEventListener("click", e => {
  if (e.target === e.currentTarget) closeStatModal();
});

document.querySelectorAll(".adm-stat-card[data-detail]").forEach(card => {
  card.addEventListener("click", () => {
    const type = card.dataset.detail;
    if (type === "users")    { showSection("users");    return; }
    if (type === "activity") { showSection("activity"); return; }
    openStatModal(type);
  });
});

async function openStatModal(type) {
  const modal = document.getElementById("statModal");
  const title = document.getElementById("statModalTitle");
  const body  = document.getElementById("statModalBody");

  title.textContent = STAT_TITLES[type] || type;
  body.innerHTML = `<div class="adm-loading">Loadingâ€¦</div>`;
  modal.hidden = false;

  try {
    const res  = await fetch(`/admin/api/stat-detail?type=${type}`);
    const data = await res.json();
    if (!data.success || !data.rows.length) {
      body.innerHTML = `<div class="adm-loading">No data yet.</div>`;
      return;
    }
    body.innerHTML = data.rows.map(row => {
      const time = row.created_at ? `<span class="adm-muted">${timeAgo(row.created_at)}</span>` : "";
      const user = row.user_name || row.user_email || "Guest";
      if (type === "resumes") {
        return `<div class="adm-detail-row">
          <div class="adm-detail-main"><strong>${row.name || "Untitled"}</strong><span class="adm-muted"> Â· ${row.template || "â€”"}</span></div>
          <div class="adm-detail-meta">${user} ${time}</div>
        </div>`;
      }
      if (type === "downloads") {
        return `<div class="adm-detail-row">
          <div class="adm-detail-main"><strong>${row.resume_name || "Untitled"}</strong><span class="adm-muted"> Â· ${row.template || "â€”"}</span></div>
          <div class="adm-detail-meta">${user} ${time}</div>
        </div>`;
      }
      if (type === "revenue") {
        return `<div class="adm-detail-row">
          <div class="adm-detail-main"><strong>â‚¹${row.amount}</strong><span class="adm-muted"> Â· ${row.resume_name || "â€”"}</span></div>
          <div class="adm-detail-meta">${user} ${time}</div>
        </div>`;
      }
      if (type === "ai") {
        return `<div class="adm-detail-row">
          <div class="adm-detail-main"><strong>${row.action_type}</strong><span class="adm-muted"> Â· ${row.route || "â€”"}</span></div>
          <div class="adm-detail-meta">${user} ${time}</div>
        </div>`;
      }
      return "";
    }).join("");
  } catch (_) {
    body.innerHTML = `<div class="adm-loading">Failed to load.</div>`;
  }
}

// â”€â”€ Activity feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activityLoaded = false;

const ACTION_ICONS = {
  visit:          { icon: "fas fa-eye",          color: "#6366f1" },
  login:          { icon: "fas fa-sign-in-alt",  color: "#22c55e" },
  resume_create:  { icon: "fas fa-file-plus",    color: "#3b82f6" },
  resume_edit:    { icon: "fas fa-pencil-alt",   color: "#f59e0b" },
  download_download: { icon: "fas fa-download",  color: "#8b5cf6" },
  download_print: { icon: "fas fa-print",        color: "#14b8a6" },
  payment:        { icon: "fas fa-rupee-sign",   color: "#16a34a" },
  ai_use:         { icon: "fas fa-robot",        color: "#ec4899" },
};

function actionLabel(type) {
  const map = {
    visit:             "visited a page",
    login:             "logged in",
    resume_create:     "created a resume",
    resume_edit:       "edited a resume",
    download_download: "downloaded a resume (JPG)",
    download_print:    "downloaded a resume (PDF)",
    payment:           "completed a payment",
    ai_use:            "used AI suggest",
  };
  return map[type] || type;
}

function timeAgo(iso) {
  const diff = Date.now() - new Date(iso).getTime();
  const m = Math.floor(diff / 60000);
  if (m < 1)  return "just now";
  if (m < 60) return m + "m ago";
  const h = Math.floor(m / 60);
  if (h < 24) return h + "h ago";
  return Math.floor(h / 24) + "d ago";
}

// â”€â”€ Grouped activity feed (one row per user + guest row) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadActivity() {
  activityLoaded = true;
  try {
    const res  = await fetch("/admin/api/activity-grouped");
    const data = await res.json();
    if (!data.success) return;

    const feed = document.getElementById("activityFeed");
    if (!data.users.length) {
      feed.innerHTML = `<div class="adm-loading">No activity recorded yet.</div>`;
      return;
    }

    feed.innerHTML = data.users.map(u => {
      // â”€â”€ Guest / anonymous row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (u.is_guest) {
        const sessions = u.unique_sessions > 0
          ? `<span class="adm-muted" style="font-size:0.78rem"> Â· ${u.unique_sessions} unique session${u.unique_sessions !== 1 ? "s" : ""}</span>`
          : "";
        return `
          <div class="adm-activity-item adm-activity-clickable adm-guest-row" onclick="openGuestActivityModal()">
            <div class="adm-guest-avatar"><i class="fas fa-globe"></i></div>
            <div class="adm-activity-text">
              <strong>Anonymous Visitors</strong>${sessions}
              <span class="adm-muted"> Â· browsing public pages</span>
            </div>
            <div style="display:flex;align-items:center;gap:0.5rem;margin-left:auto;flex-shrink:0">
              <span class="adm-act-count adm-act-count-guest">${u.activity_count}</span>
              <span class="adm-activity-time">${timeAgo(u.last_active)}</span>
              <i class="fas fa-chevron-right" style="color:#cbd5e1;font-size:0.7rem"></i>
            </div>
          </div>`;
      }

      // â”€â”€ Authenticated user row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const name   = u.user_name || u.user_email || "User";
      const letter = name[0].toUpperCase();
      const avatar = u.profile_image_url
        ? `<img src="${u.profile_image_url}" class="adm-avatar-sm" alt="">`
        : `<span class="adm-avatar-init" style="font-size:0.7rem">${letter}</span>`;

      return `
        <div class="adm-activity-item adm-activity-clickable" onclick="openUserActivityModal(${u.user_id}, '${name.replace(/'/g,"\\'")}')">
          ${avatar}
          <div class="adm-activity-text">
            <strong>${name}</strong>
            <span class="adm-muted"> Â· ${actionLabel(u.last_action)}</span>
          </div>
          <div style="display:flex;align-items:center;gap:0.5rem;margin-left:auto;flex-shrink:0">
            <span class="adm-act-count">${u.activity_count}</span>
            <span class="adm-activity-time">${timeAgo(u.last_active)}</span>
            <i class="fas fa-chevron-right" style="color:#cbd5e1;font-size:0.7rem"></i>
          </div>
        </div>`;
    }).join("");
  } catch (_) {}
}

// â”€â”€ Guest activity drill-down modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openGuestActivityModal() {
  const modal = document.getElementById("guestActModal");
  const body  = document.getElementById("guestActModalBody");
  body.innerHTML = `<div class="adm-loading">Loadingâ€¦</div>`;
  modal.hidden = false;

  try {
    const res  = await fetch("/admin/api/guest-activity");
    const data = await res.json();
    if (!data.success) { body.innerHTML = `<div class="adm-loading">Failed to load.</div>`; return; }

    let html = "";

    if (data.routes.length) {
      html += `<div class="adm-guest-section-title">Pages visited (all time)</div>`;
      html += data.routes.map(r => `
        <div class="adm-detail-row">
          <div class="adm-detail-main">
            <i class="fas fa-link" style="color:#6366f1;font-size:0.75rem;margin-right:0.35rem"></i>
            <strong>${r.route}</strong>
          </div>
          <div class="adm-detail-meta">
            <span class="adm-act-count adm-act-count-guest" style="margin-right:0.35rem">${r.visits}</span>
            ${timeAgo(r.last_visit)}
          </div>
        </div>`).join("");
    }

    if (data.recent.length) {
      html += `<div class="adm-guest-section-title" style="margin-top:1rem">Recent visits</div>`;
      html += data.recent.map(r => `
        <div class="adm-detail-row">
          <div class="adm-detail-main" style="color:#374151">${r.route || "/"}</div>
          <div class="adm-detail-meta">${r.ip_address || "â€”"} Â· ${timeAgo(r.created_at)}</div>
        </div>`).join("");
    }

    body.innerHTML = html || `<div class="adm-loading">No guest visits yet.</div>`;
  } catch (_) {
    body.innerHTML = `<div class="adm-loading">Failed to load.</div>`;
  }
}

document.getElementById("guestActModalClose").addEventListener("click", () => {
  document.getElementById("guestActModal").hidden = true;
});
document.getElementById("guestActModal").addEventListener("click", e => {
  if (e.target === e.currentTarget) e.currentTarget.hidden = true;
});

// â”€â”€ User activity detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openUserActivityModal(uid, userName) {
  const modal = document.getElementById("userActModal");
  const title = document.getElementById("userActModalTitle");
  const body  = document.getElementById("userActModalBody");

  title.textContent = userName + "'s Activity";
  body.innerHTML = `<div class="adm-loading">Loadingâ€¦</div>`;
  modal.hidden = false;

  try {
    const res  = await fetch(`/admin/api/user-activity/${uid}`);
    const data = await res.json();
    if (!data.success || !data.activities.length) {
      body.innerHTML = `<div class="adm-loading">No activity found.</div>`;
      return;
    }
    body.innerHTML = data.activities.map(a => {
      const cfg = ACTION_ICONS[a.action_type] || { icon: "fas fa-circle", color: "#6b7280" };
      return `
        <div class="adm-activity-item" style="cursor:default">
          <div class="adm-activity-icon" style="background:${cfg.color}20;color:${cfg.color}">
            <i class="${cfg.icon}"></i>
          </div>
          <div class="adm-activity-text">
            ${actionLabel(a.action_type)}
            ${a.route ? `<span class="adm-muted"> Â· ${a.route}</span>` : ""}
          </div>
          <div class="adm-activity-time">${timeAgo(a.created_at)}</div>
        </div>`;
    }).join("");
  } catch (_) {
    body.innerHTML = `<div class="adm-loading">Failed to load.</div>`;
  }
}

document.getElementById("userActModalClose").addEventListener("click", () => {
  document.getElementById("userActModal").hidden = true;
});
document.getElementById("userActModal").addEventListener("click", e => {
  if (e.target === e.currentTarget) document.getElementById("userActModal").hidden = true;
});

// â”€â”€ Delete activity log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PERIOD_LABELS = {
  recent:    "last 1 hour",
  today:     "today",
  yesterday: "yesterday",
  all:       "ALL activity (this cannot be undone)",
};

let pendingDeletePeriod = null;

document.getElementById("actDeletePeriod").addEventListener("change", function () {
  const period = this.value;
  if (!period) return;
  pendingDeletePeriod = period;
  document.getElementById("actDeleteMsg").innerHTML =
    `Are you sure you want to delete activity from <strong>${PERIOD_LABELS[period]}</strong>?`;
  document.getElementById("actDeleteModal").hidden = false;
  this.value = ""; // reset dropdown
});

document.getElementById("actDeleteCancel").addEventListener("click", () => {
  document.getElementById("actDeleteModal").hidden = true;
  pendingDeletePeriod = null;
});

document.getElementById("actDeleteConfirm").addEventListener("click", async () => {
  if (!pendingDeletePeriod) return;
  const btn = document.getElementById("actDeleteConfirm");
  btn.disabled = true;
  btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Deletingâ€¦`;

  try {
    const res  = await fetch(`/admin/api/activity?period=${pendingDeletePeriod}`, { method: "DELETE" });
    const data = await res.json();
    document.getElementById("actDeleteModal").hidden = true;
    pendingDeletePeriod = null;
    if (data.success) {
      activityLoaded = false;
      loadActivity(); // refresh feed
    }
  } catch (_) {
    document.getElementById("actDeleteModal").hidden = true;
  } finally {
    btn.disabled = false;
    btn.innerHTML = `<i class="fas fa-trash-alt"></i> Yes, Delete`;
  }
});

// Poll activity every 30 s when on that section
setInterval(() => {
  if (!document.getElementById("activity").hidden) loadActivity();
}, 30000);

// â”€â”€ Service Requests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let srLoaded       = false;
let srCurrentPage  = 1;
let srFilterStatus = "";

const SR_SERVICE_LABELS = {
  resume:       "AI Resume",
  logo:         "Logo + Brand",
  landing_page: "Landing Page",
  other:        "Other",
  chat:         "ðŸ’¬ Guest Chat",
};

const SR_STATUS_CFG = {
  new:         { label: "New",         cls: "adm-sr-badge-new"         },
  in_progress: { label: "In Progress", cls: "adm-sr-badge-inprogress"  },
  done:        { label: "Done",        cls: "adm-sr-badge-done"        },
  closed:      { label: "Closed",      cls: "adm-sr-badge-closed"      },
};

async function loadServiceRequests(page, status) {
  srLoaded       = true;
  srCurrentPage  = page  ?? srCurrentPage;
  srFilterStatus = status !== undefined ? status : srFilterStatus;

  const params = new URLSearchParams({ page: srCurrentPage, limit: 20 });
  if (srFilterStatus) params.set("status", srFilterStatus);

  try {
    const res  = await fetch("/admin/api/service-requests?" + params);
    const data = await res.json();
    if (!data.success) return;

    // Update nav badge with "new" count
    const newCount = data.requests.filter(r => r.status === "new").length;
    const navBadge = document.getElementById("navRequestsBadge");
    if (newCount > 0) { navBadge.textContent = newCount; navBadge.hidden = false; }
    else              { navBadge.hidden = true; }

    const tbody = document.getElementById("srBody");
    if (!data.requests.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="adm-loading">No requests found.</td></tr>`;
      document.getElementById("srPagination").innerHTML = "";
      return;
    }

    tbody.innerHTML = data.requests.map(r => {
      const cfg     = SR_STATUS_CFG[r.status] || SR_STATUS_CFG.new;
      const service = SR_SERVICE_LABELS[r.service_type] || r.service_type;
      const snippet = r.details ? (r.details.length > 60 ? r.details.slice(0, 60) + "â€¦" : r.details) : "â€”";
      return `
        <tr data-srid="${r.id}">
          <td>
            <div style="font-weight:600;font-size:0.85rem">${r.name}</div>
            <div class="adm-muted" style="font-size:0.75rem">${r.email}</div>
          </td>
          <td><span class="adm-sr-type">${service}</span></td>
          <td class="adm-sr-details-cell" onclick="openSrDetail(${r.id})" title="Click to read full details">${snippet}</td>
          <td>
            <select class="adm-sr-status-select ${cfg.cls}" onchange="updateSrStatus(${r.id}, this)">
              ${["new","in_progress","done","closed"].map(s =>
                `<option value="${s}" ${r.status === s ? "selected" : ""}>${SR_STATUS_CFG[s].label}</option>`
              ).join("")}
            </select>
          </td>
          <td class="adm-muted" style="font-size:0.78rem;white-space:nowrap">${fmtDate(r.created_at)}</td>
          <td>
            <button class="adm-sr-chat-btn" title="Open chat" onclick="admOpenChat(${r.id},'${r.name.replace(/'/g,"\\'")}','${r.email.replace(/'/g,"\\'")}')">
              <i class="fas fa-comment-dots"></i>
            </button>
          </td>
          <td>
            <button class="adm-sr-del-btn" onclick="confirmDeleteSr(${r.id}, '${r.name.replace(/'/g,"\\'")}')">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        </tr>`;
    }).join("");

    // Pagination
    const pages = Math.ceil(data.total / data.limit);
    const pgEl  = document.getElementById("srPagination");
    pgEl.innerHTML = "";
    for (let p = 1; p <= pages; p++) {
      const btn = document.createElement("button");
      btn.textContent = p;
      btn.className   = "adm-page-btn" + (p === srCurrentPage ? " adm-page-active" : "");
      btn.addEventListener("click", () => loadServiceRequests(p));
      pgEl.appendChild(btn);
    }
  } catch (_) {}
}

// â”€â”€ Status dropdown per row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateSrStatus(id, selectEl) {
  const newStatus = selectEl.value;
  const cfg = SR_STATUS_CFG[newStatus];
  try {
    const res  = await fetch(`/admin/api/service-request/${id}/status`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newStatus }),
    });
    const data = await res.json();
    if (data.success) {
      // Update select colour class
      selectEl.className = `adm-sr-status-select ${cfg.cls}`;
    } else {
      alert("Failed to update status.");
      loadServiceRequests(srCurrentPage); // revert
    }
  } catch (_) { alert("Network error."); }
}

// â”€â”€ Detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let srCache = {};

async function openSrDetail(id) {
  const modal = document.getElementById("srDetailModal");
  const title = document.getElementById("srDetailTitle");
  const body  = document.getElementById("srDetailBody");

  // Use cached row data from the table if available
  const row = document.querySelector(`tr[data-srid="${id}"]`);
  if (row) {
    const name    = row.cells[0].querySelector("div").textContent;
    const email   = row.cells[0].querySelector(".adm-muted").textContent;
    const service = row.cells[1].textContent.trim();
    title.textContent = `${name} â€” ${service}`;
    body.innerHTML = `
      <div class="adm-modal-field"><span class="adm-modal-label">Email</span><span>${email}</span></div>
      <div class="adm-modal-field"><span class="adm-modal-label">Date</span><span>${row.cells[4].textContent.trim()}</span></div>
      <div style="margin-top:0.75rem">
        <div class="adm-modal-label" style="margin-bottom:0.4rem">Details</div>
        <div id="srFullDetails" style="font-size:0.875rem;color:#374151;line-height:1.6;background:#f8fafc;border-radius:8px;padding:0.75rem">Loadingâ€¦</div>
      </div>`;
    modal.hidden = false;
  }

  // Fetch full details from server (the table row only has a snippet)
  try {
    const res  = await fetch(`/admin/api/service-requests?page=1&limit=50`);
    const data = await res.json();
    const req  = data.requests.find(r => r.id === id);
    if (req) {
      const el = document.getElementById("srFullDetails");
      if (el) el.textContent = req.details || "No details provided.";
    }
  } catch (_) {}
}

document.getElementById("srDetailClose").addEventListener("click", () => {
  document.getElementById("srDetailModal").hidden = true;
});
document.getElementById("srDetailModal").addEventListener("click", e => {
  if (e.target === e.currentTarget) e.currentTarget.hidden = true;
});

// â”€â”€ Delete request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingSrDeleteId = null;

function confirmDeleteSr(id, name) {
  pendingSrDeleteId = id;
  document.getElementById("srDeleteMsg").innerHTML =
    `Are you sure you want to delete the request from <strong>${name}</strong>?`;
  document.getElementById("srDeleteModal").hidden = false;
}

document.getElementById("srDeleteCancel").addEventListener("click", () => {
  document.getElementById("srDeleteModal").hidden = true;
  pendingSrDeleteId = null;
});
document.getElementById("srDeleteModal").addEventListener("click", e => {
  if (e.target === e.currentTarget) { e.currentTarget.hidden = true; pendingSrDeleteId = null; }
});

document.getElementById("srDeleteConfirm").addEventListener("click", async function () {
  if (!pendingSrDeleteId) return;
  this.disabled = true;
  this.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Deletingâ€¦`;
  try {
    const res  = await fetch(`/admin/api/service-request/${pendingSrDeleteId}`, { method: "DELETE" });
    const data = await res.json();
    document.getElementById("srDeleteModal").hidden = true;
    if (data.success) {
      document.querySelector(`tr[data-srid="${pendingSrDeleteId}"]`)?.remove();
    }
  } catch (_) {}
  finally {
    this.disabled = false;
    this.innerHTML = `<i class="fas fa-trash-alt"></i> Yes, Delete`;
    pendingSrDeleteId = null;
  }
});

// Load on section switch + filter change
document.getElementById("srFilterStatus").addEventListener("change", function () {
  loadServiceRequests(1, this.value);
});

// â”€â”€ Admin Socket.io chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const admSocket = io({ autoConnect: true });
let admActiveChatId = null;

function admOpenChat(requestId, name, email) {
  admActiveChatId = requestId;
  document.getElementById("admChatTitle").textContent = name || "User";
  document.getElementById("admChatSub").textContent   = email || "";
  document.getElementById("admChatMessages").innerHTML = '<div class="adm-chat-empty">Loading messagesâ€¦</div>';
  document.getElementById("admChatModal").hidden = false;
  document.getElementById("admChatInput").focus();

  admSocket.emit("join-request", requestId);

  fetch(`/api/request/${requestId}/messages`)
    .then(r => r.json())
    .then(data => {
      if (!data.success) return;
      const el = document.getElementById("admChatMessages");
      if (!data.messages.length) {
        el.innerHTML = '<div class="adm-chat-empty">No messages yet.</div>';
        return;
      }
      el.innerHTML = "";
      data.messages.forEach(m => admAppendMessage(m, false));
      el.scrollTop = el.scrollHeight;
    })
    .catch(() => {});
}

function admAppendMessage(m, scroll = true) {
  const isAdmin = m.sender_role === "admin";
  const el = document.getElementById("admChatMessages");
  const empty = el.querySelector(".adm-chat-empty");
  if (empty) empty.remove();

  const row = document.createElement("div");
  row.className = `adm-chat-bubble-row ${isAdmin ? "mine" : "theirs"}`;
  const time = new Date(m.created_at).toLocaleTimeString("en-IN", { hour: "2-digit", minute: "2-digit" });
  const name = isAdmin ? "You (Admin)" : (m.sender_name || "User");

  row.innerHTML = `
    ${!isAdmin ? `<div class="adm-chat-sender-name">${name}</div>` : ""}
    <div class="adm-chat-bubble ${isAdmin ? "mine" : "theirs"}">${admEscHtml(m.message)}</div>
    <div class="adm-chat-bubble-meta">${time}</div>`;
  el.appendChild(row);
  if (scroll) el.scrollTop = el.scrollHeight;
}

function admEscHtml(str) {
  return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

admSocket.on("message", (m) => {
  if (m.request_id !== admActiveChatId) return;
  admAppendMessage(m, true);
});

document.getElementById("admChatForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const input = document.getElementById("admChatInput");
  const msg   = input.value.trim();
  if (!msg || !admActiveChatId) return;
  admSocket.emit("send-message", { requestId: admActiveChatId, message: msg });
  input.value = "";
  input.style.height = "";
  input.focus();
});

document.getElementById("admChatInput").addEventListener("input", function () {
  this.style.height = "auto";
  this.style.height = Math.min(this.scrollHeight, 120) + "px";
});

document.getElementById("admChatInput").addEventListener("keydown", function (e) {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); document.getElementById("admChatForm").requestSubmit(); }
});

document.getElementById("admChatClose").addEventListener("click", () => {
  document.getElementById("admChatModal").hidden = true;
  admActiveChatId = null;
});
document.getElementById("admChatModal").addEventListener("click", function (e) {
  if (e.target === this) { this.hidden = true; admActiveChatId = null; }
});

// â”€â”€ Pricing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pricingLoaded = false;

async function loadPricing() {
  try {
    const res  = await fetch("/admin/api/settings");
    const data = await res.json();
    if (!data.success) return;
    ["price_fresher", "price_experienced", "price_developer", "price_ats-friendly"].forEach(key => {
      const input = document.getElementById(key);
      if (input && data.settings[key] !== undefined) input.value = data.settings[key];
    });
    pricingLoaded = true;
  } catch (err) {
    console.error("Failed to load pricing:", err);
  }
}

document.querySelectorAll(".adm-price-save-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const key    = btn.dataset.key;
    const input  = document.getElementById(key);
    const status = document.getElementById("status_" + key);
    if (!input || !status) return;

    const value = input.value.trim();
    if (!value || isNaN(parseInt(value, 10)) || parseInt(value, 10) < 0) {
      showPriceStatus(status, "error", "Invalid price");
      return;
    }

    btn.disabled = true;
    try {
      const res  = await fetch("/admin/api/settings", {
        method:  "PATCH",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify({ [key]: value }),
      });
      const data = await res.json();
      if (data.success) {
        showPriceStatus(status, "ok", "Saved âœ“");
      } else {
        showPriceStatus(status, "error", data.message || "Error");
      }
    } catch (_) {
      showPriceStatus(status, "error", "Network error");
    } finally {
      btn.disabled = false;
    }
  });
});

function showPriceStatus(el, type, msg) {
  el.textContent = msg;
  el.className   = "adm-price-status adm-price-status-" + type;
  el.hidden      = false;
  setTimeout(() => { el.hidden = true; }, 3000);
}
</script>

<%- include("../partials/footer") %>
